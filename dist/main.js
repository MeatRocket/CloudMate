"use strict";
exports.__esModule = true;
var config_1 = require("./config");
var chokidar = require("chokidar");
var gulp = require('gulp');
var gulpLess = require('gulp-less');
var gulpSass = require('gulp-sass');
var gulpRename = require('gulp-rename');
var gulpConcat = require("gulp-concat");
var gulpTs = require("gulp-typescript");
var gulpSourcemaps = require("gulp-sourcemaps");
var gulpUglify = require('gulp-uglify');
var merge2 = require('merge2');
var gulpCleanCSS = require('gulp-clean-css');
var gulpFilter = require('gulp-filter-each');
var path = require('path');
var bundle = function (files, build) {
    var process = [];
    var groupFilesExtention = '';
    var groupedFiles = [];
    files.forEach(function (file) {
        var fileExtention = file.split('.').pop().toLowerCase();
        if (fileExtention !== groupFilesExtention) {
            if (groupedFiles.length > 0) {
                process.push(compile(groupedFiles, groupFilesExtention, build));
                groupedFiles = [];
            }
            groupFilesExtention = fileExtention;
        }
        groupedFiles.push(file);
    });
    if (groupedFiles.length > 0)
        process.push(compile(groupedFiles, groupFilesExtention, build));
    var stream = merge2();
    process.forEach(function (p) {
        stream.add(p);
    });
    return stream;
};
var compile = function (files, extention, build) {
    var process = gulp.src(files);
    switch (extention) {
        case 'css':
            return process.pipe(gulpConcat('empty'));
        case 'less':
            if (build.css.sourceMap)
                process = process.pipe(gulpSourcemaps.init());
            process = process.pipe(gulpLess());
            if (build.css.sourceMap)
                process = process.pipe(gulpSourcemaps.write());
            return process.pipe(gulpConcat('empty'));
        case 'scss':
            if (build.css.sourceMap)
                process = process.pipe(gulpSourcemaps.init());
            process = process.pipe(gulpSass().on('error', gulpSass.logError));
            if (build.css.sourceMap)
                process = process.pipe(gulpSourcemaps.write());
            return process.pipe(gulpConcat('empty'));
        case 'ts':
            if (build.js.sourceMap)
                process = process.pipe(gulpSourcemaps.init());
            process = process.pipe(gulpTs());
            if (build.js.sourceMap)
                process = process.pipe(gulpSourcemaps.write());
            return process.pipe(gulpConcat('empty'));
        case 'd.ts':
            return process
                .pipe(gulpTs(build.ts.compilerOptions));
    }
    return process;
};
var createTypeScriptDeclaration = function (files, outputDirectory, outputFileName, build) {
    var typescriptDeclarations = [];
    files.forEach(function (file) {
        var fileExtention = file.split('.').pop().toLowerCase();
        if (fileExtention === 'ts')
            typescriptDeclarations.push(file);
    });
    if (typescriptDeclarations.length > 0)
        compile(typescriptDeclarations, 'd.ts', build)
            .pipe(gulpFilter(function (content, filepath) { return filepath.toLowerCase().endsWith('.d.ts'); }))
            .pipe(gulpConcat('empty'))
            .pipe(gulpRename({
            basename: outputFileName.replace('.js', ''),
            suffix: '.d',
            extname: '.ts'
        }))
            .pipe(gulp.dest(outputDirectory));
};
var allWatchers = [];
exports.watch = function (builds) {
    if (builds === undefined || (builds !== null && builds.length === 0))
        builds = ['dev'];
    var configWatcher = chokidar.watch('mateconfig.json', { persistent: true })
        .on('change', function (event, path) {
        allWatchers.forEach(function (watcher) {
            watcher.close();
        });
        allWatchers = [];
        exports.watch(builds);
    });
    allWatchers.push(configWatcher);
    var config = config_1.MateConfig.get();
    config.files.forEach(function (file) {
        file.builds.forEach(function (buildName) {
            if (builds === null || builds.indexOf(buildName) !== -1) {
                var watch_1 = chokidar.watch(file.input, { persistent: true })
                    .on('change', function (event, path) {
                    runFiles(config, file, [buildName]);
                });
                allWatchers.push(watch_1);
            }
        });
    });
    exports.runBuild(builds);
};
exports.runBuild = function (builds) {
    var config = config_1.MateConfig.get();
    config.files.forEach(function (file) {
        runFiles(config, file, builds);
    });
};
var runFiles = function (config, file, builds) {
    if (builds === undefined || (builds !== null && builds.length === 0))
        builds = ['dev'];
    file.output.forEach(function (output) {
        var outputExtention = output.split('.').pop().toLowerCase();
        var outputFileName = output.replace(/^.*[\\\/]/, '');
        file.builds.forEach(function (buildName) {
            if (builds !== null && builds.indexOf(buildName) === -1)
                return;
            var build = config.getBuild(buildName);
            var outputDirectory = build.outDir ? build.outDir : path.dirname(output);
            if (build.outDirVersioning)
                outputDirectory += '/' + config.getOutDirVersion();
            if (build.outDirName)
                outputDirectory += '/' + config.getOutDirName();
            switch (outputExtention) {
                case 'css':
                    if (build.css.outDirSuffix)
                        outputDirectory += '/' + build.css.outDirSuffix;
                    break;
                case 'js':
                    if (build.js.outDirSuffix)
                        outputDirectory += '/' + build.js.outDirSuffix;
                    break;
            }
            if (build.ts.compilerOptions.declaration === true)
                createTypeScriptDeclaration(file.input, outputDirectory, outputFileName, build);
            var process = bundle(file.input, build)
                .pipe(gulpConcat('empty'))
                .pipe(gulpRename(outputFileName))
                .pipe(gulp.dest(outputDirectory));
            switch (outputExtention) {
                case 'css':
                    if (build.css.minify) {
                        process.pipe(gulpCleanCSS())
                            .pipe(gulpRename({ suffix: ".min" }))
                            .pipe(gulp.dest(outputDirectory));
                    }
                    break;
                case 'js':
                    if (build.js.minify) {
                        process.pipe(gulpUglify())
                            .pipe(gulpRename({ suffix: ".min" }))
                            .pipe(gulp.dest(outputDirectory));
                    }
                    break;
            }
        });
    });
};

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QyxVQUFVLENBQUMsY0FBYyxDQUFDLENBQUM7aUJBQ2hDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUM7WUFFbEMsUUFBUSxlQUFlLEVBQUU7Z0JBRXJCLEtBQUssS0FBSztvQkFFTixJQUFJLEtBQUssQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFO3dCQUVsQixPQUFPLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDOzZCQUMzQixJQUFJLENBQUMsVUFBVSxDQUFDLEVBQUMsTUFBTSxFQUFFLE1BQU0sRUFBQyxDQUFDLENBQUM7NkJBQ2xDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUM7cUJBQ3JDO29CQUNELE1BQU07Z0JBRVYsS0FBSyxJQUFJO29CQUVMLElBQUksS0FBSyxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUU7d0JBRWpCLE9BQU8sQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7NkJBQ3pCLElBQUksQ0FBQyxVQUFVLENBQUMsRUFBQyxNQUFNLEVBQUUsTUFBTSxFQUFDLENBQUMsQ0FBQzs2QkFDbEMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQztxQkFDckM7b0JBQ0QsTUFBTTthQUNiO1FBRUwsQ0FBQyxDQUFDLENBQUM7SUFFUCxDQUFDLENBQUMsQ0FBQztBQUNQLENBQUMsQ0FBQSIsImZpbGUiOiJtYWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTWF0ZUNvbmZpZywgTWF0ZUNvbmZpZ0NTU0NvbmZpZywgTWF0ZUNvbmZpZ0J1aWxkLCBNYXRlQ29uZmlnRmlsZSB9IGZyb20gXCIuL2NvbmZpZ1wiO1xyXG5pbXBvcnQgY2hva2lkYXIgPSByZXF1aXJlKCdjaG9raWRhcicpO1xyXG5cclxuY29uc3QgZ3VscCA9IHJlcXVpcmUoJ2d1bHAnKTtcclxuY29uc3QgZ3VscExlc3MgPSByZXF1aXJlKCdndWxwLWxlc3MnKTtcclxuY29uc3QgZ3VscFNhc3MgPSByZXF1aXJlKCdndWxwLXNhc3MnKTtcclxuY29uc3QgZ3VscFJlbmFtZSA9IHJlcXVpcmUoJ2d1bHAtcmVuYW1lJyk7XHJcbmNvbnN0IGd1bHBDb25jYXQgPSByZXF1aXJlKFwiZ3VscC1jb25jYXRcIik7XHJcbmNvbnN0IGd1bHBUcyA9IHJlcXVpcmUoXCJndWxwLXR5cGVzY3JpcHRcIik7XHJcbmNvbnN0IGd1bHBTb3VyY2VtYXBzID0gcmVxdWlyZShcImd1bHAtc291cmNlbWFwc1wiKTtcclxuY29uc3QgZ3VscFVnbGlmeSA9IHJlcXVpcmUoJ2d1bHAtdWdsaWZ5Jyk7XHJcbmNvbnN0IG1lcmdlMiA9IHJlcXVpcmUoJ21lcmdlMicpO1xyXG5jb25zdCBndWxwQ2xlYW5DU1MgPSByZXF1aXJlKCdndWxwLWNsZWFuLWNzcycpO1xyXG5jb25zdCBndWxwRmlsdGVyID0gcmVxdWlyZSgnZ3VscC1maWx0ZXItZWFjaCcpO1xyXG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xyXG5cclxuY29uc3QgYnVuZGxlID0gZnVuY3Rpb24oZmlsZXM6IHN0cmluZ1tdLCBidWlsZDogTWF0ZUNvbmZpZ0J1aWxkKTogYW55IHtcclxuXHJcbiAgICBjb25zdCBwcm9jZXNzOiBhbnlbXSA9IFtdO1xyXG5cclxuICAgIGxldCBncm91cEZpbGVzRXh0ZW50aW9uID0gJyc7XHJcbiAgICBsZXQgZ3JvdXBlZEZpbGVzOiBzdHJpbmdbXSA9IFtdO1xyXG4gICAgXHJcbiAgICBmaWxlcy5mb3JFYWNoKChmaWxlKSA9PntcclxuXHJcbiAgICAgICAgY29uc3QgZmlsZUV4dGVudGlvbiA9IGZpbGUuc3BsaXQoJy4nKS5wb3AoKS50b0xvd2VyQ2FzZSgpO1xyXG5cclxuICAgICAgICBpZiAoZmlsZUV4dGVudGlvbiAhPT0gZ3JvdXBGaWxlc0V4dGVudGlvbil7XHJcblxyXG4gICAgICAgICAgICBpZiAoZ3JvdXBlZEZpbGVzLmxlbmd0aCA+IDApXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIHByb2Nlc3MucHVzaChjb21waWxlKGdyb3VwZWRGaWxlcywgZ3JvdXBGaWxlc0V4dGVudGlvbiwgYnVpbGQpKTtcclxuICAgICAgICAgICAgICAgIGdyb3VwZWRGaWxlcyA9IFtdXHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGdyb3VwRmlsZXNFeHRlbnRpb24gPSBmaWxlRXh0ZW50aW9uO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgZ3JvdXBlZEZpbGVzLnB1c2goZmlsZSk7XHJcblxyXG4gICAgfSk7XHJcblxyXG4gICAgaWYgKGdyb3VwZWRGaWxlcy5sZW5ndGggPiAwKVxyXG4gICAgICAgIHByb2Nlc3MucHVzaChjb21waWxlKGdyb3VwZWRGaWxlcywgZ3JvdXBGaWxlc0V4dGVudGlvbiwgYnVpbGQpKTtcclxuXHJcbiAgIGNvbnN0IHN0cmVhbSA9IG1lcmdlMigpO1xyXG5cclxuICAgcHJvY2Vzcy5mb3JFYWNoKChwKSA9PntcclxuICAgIHN0cmVhbS5hZGQocCk7XHJcbiAgIH0pO1xyXG4gICAgXHJcbiAgIHJldHVybiBzdHJlYW07XHJcbn1cclxuXHJcbmNvbnN0IGNvbXBpbGUgPSBmdW5jdGlvbihmaWxlczogc3RyaW5nW10sIGV4dGVudGlvbjogc3RyaW5nLCBidWlsZDogTWF0ZUNvbmZpZ0J1aWxkKTogYW55IHtcclxuXHJcbiAgICBsZXQgcHJvY2VzcyA9IGd1bHAuc3JjKGZpbGVzKTtcclxuXHJcbiAgICBzd2l0Y2ggKGV4dGVudGlvbil7XHJcbiAgICAgICAgY2FzZSAnY3NzJzpcclxuICAgICAgICAgICAgcmV0dXJuIHByb2Nlc3MucGlwZShndWxwQ29uY2F0KCdlbXB0eScpKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgY2FzZSAnbGVzcyc6XHJcblxyXG4gICAgICAgICAgICBpZiAoYnVpbGQuY3NzLnNvdXJjZU1hcClcclxuICAgICAgICAgICAgICAgIHByb2Nlc3MgPSBwcm9jZXNzLnBpcGUoZ3VscFNvdXJjZW1hcHMuaW5pdCgpKTtcclxuXHJcbiAgICAgICAgICAgIHByb2Nlc3MgPSBwcm9jZXNzLnBpcGUoZ3VscExlc3MoKSk7ICAgIFxyXG5cclxuICAgICAgICAgICAgaWYgKGJ1aWxkLmNzcy5zb3VyY2VNYXApXHJcbiAgICAgICAgICAgICAgICBwcm9jZXNzID0gcHJvY2Vzcy5waXBlKGd1bHBTb3VyY2VtYXBzLndyaXRlKCkpO1xyXG5cclxuICAgICAgICAgICAgcmV0dXJuIHByb2Nlc3MucGlwZShndWxwQ29uY2F0KCdlbXB0eScpKTtcclxuXHJcbiAgICAgICAgY2FzZSAnc2Nzcyc6XHJcblxyXG4gICAgICAgICAgICBpZiAoYnVpbGQuY3NzLnNvdXJjZU1hcClcclxuICAgICAgICAgICAgICAgIHByb2Nlc3MgPSBwcm9jZXNzLnBpcGUoZ3VscFNvdXJjZW1hcHMuaW5pdCgpKTtcclxuXHJcbiAgICAgICAgICAgIHByb2Nlc3MgPSBwcm9jZXNzLnBpcGUoZ3VscFNhc3MoKS5vbignZXJyb3InLCBndWxwU2Fzcy5sb2dFcnJvcikpOyAgICBcclxuXHJcbiAgICAgICAgICAgIGlmIChidWlsZC5jc3Muc291cmNlTWFwKVxyXG4gICAgICAgICAgICAgICAgcHJvY2VzcyA9IHByb2Nlc3MucGlwZShndWxwU291cmNlbWFwcy53cml0ZSgpKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIHJldHVybiBwcm9jZXNzLnBpcGUoZ3VscENvbmNhdCgnZW1wdHknKSk7XHJcbiAgICBcclxuICAgICAgICBjYXNlICd0cyc6XHJcblxyXG4gICAgICAgICAgICBpZiAoYnVpbGQuanMuc291cmNlTWFwKVxyXG4gICAgICAgICAgICAgICAgcHJvY2VzcyA9IHByb2Nlc3MucGlwZShndWxwU291cmNlbWFwcy5pbml0KCkpO1xyXG5cclxuICAgICAgICAgICAgcHJvY2VzcyA9IHByb2Nlc3MucGlwZShndWxwVHMoKSk7XHJcblxyXG4gICAgICAgICAgICBpZiAoYnVpbGQuanMuc291cmNlTWFwKVxyXG4gICAgICAgICAgICAgICAgcHJvY2VzcyA9IHByb2Nlc3MucGlwZShndWxwU291cmNlbWFwcy53cml0ZSgpKTtcclxuXHJcbiAgICAgICAgICAgIHJldHVybiBwcm9jZXNzLnBpcGUoZ3VscENvbmNhdCgnZW1wdHknKSk7XHJcblxyXG4gICAgICAgIGNhc2UgJ2QudHMnOlxyXG4gICAgICAgICAgICByZXR1cm4gcHJvY2Vzc1xyXG4gICAgICAgICAgICAgICAgICAgIC5waXBlKGd1bHBUcyhidWlsZC50cy5jb21waWxlck9wdGlvbnMpKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gcHJvY2VzcztcclxufVxyXG5cclxuY29uc3QgY3JlYXRlVHlwZVNjcmlwdERlY2xhcmF0aW9uID0gZnVuY3Rpb24oZmlsZXM6IHN0cmluZyBbXSwgb3V0cHV0RGlyZWN0b3J5OiBzdHJpbmcsIG91dHB1dEZpbGVOYW1lOiBzdHJpbmcsIGJ1aWxkOiBNYXRlQ29uZmlnQnVpbGQpOiB2b2lkIHtcclxuXHJcbiAgICBjb25zdCB0eXBlc2NyaXB0RGVjbGFyYXRpb25zOiBzdHJpbmdbXSA9IFtdO1xyXG4gICAgXHJcbiAgICBmaWxlcy5mb3JFYWNoKChmaWxlKSA9PiB7XHJcbiAgICAgICAgY29uc3QgZmlsZUV4dGVudGlvbiA9IGZpbGUuc3BsaXQoJy4nKS5wb3AoKS50b0xvd2VyQ2FzZSgpO1xyXG5cclxuICAgICAgICBpZiAoZmlsZUV4dGVudGlvbiA9PT0gJ3RzJylcclxuICAgICAgICAgICAgdHlwZXNjcmlwdERlY2xhcmF0aW9ucy5wdXNoKGZpbGUpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaWYgKHR5cGVzY3JpcHREZWNsYXJhdGlvbnMubGVuZ3RoID4gMClcclxuICAgICAgICBjb21waWxlKHR5cGVzY3JpcHREZWNsYXJhdGlvbnMsICdkLnRzJywgYnVpbGQpXHJcbiAgICAgICAgICAgIC5waXBlKGd1bHBGaWx0ZXIoKGNvbnRlbnQsIGZpbGVwYXRoOiBzdHJpbmcpID0+IGZpbGVwYXRoLnRvTG93ZXJDYXNlKCkuZW5kc1dpdGgoJy5kLnRzJykpKVxyXG4gICAgICAgICAgICAucGlwZShndWxwQ29uY2F0KCdlbXB0eScpKVxyXG4gICAgICAgICAgICAucGlwZShndWxwUmVuYW1lKHtcclxuICAgICAgICAgICAgICAgIGJhc2VuYW1lOiBvdXRwdXRGaWxlTmFtZS5yZXBsYWNlKCcuanMnLCAnJyksXHJcbiAgICAgICAgICAgICAgICBzdWZmaXg6ICcuZCcsXHJcbiAgICAgICAgICAgICAgICBleHRuYW1lOiAnLnRzJ1xyXG4gICAgICAgICAgICB9KSlcclxuICAgICAgICAgICAgLnBpcGUoZ3VscC5kZXN0KG91dHB1dERpcmVjdG9yeSkpO1xyXG59XHJcblxyXG5sZXQgYWxsV2F0Y2hlcnM6IGNob2tpZGFyLkZTV2F0Y2hlcltdID0gW107XHJcblxyXG5leHBvcnQgY29uc3Qgd2F0Y2ggPSBmdW5jdGlvbihidWlsZHM/OiBzdHJpbmdbXSkge1xyXG5cclxuICAgIGlmIChidWlsZHMgPT09IHVuZGVmaW5lZCB8fCAoYnVpbGRzICE9PSBudWxsICYmIGJ1aWxkcy5sZW5ndGggPT09IDApKVxyXG4gICAgICAgIGJ1aWxkcyA9IFsnZGV2J107XHJcblxyXG4gICAgY29uc3QgY29uZmlnV2F0Y2hlciA9IGNob2tpZGFyLndhdGNoKCdtYXRlY29uZmlnLmpzb24nLCB7IHBlcnNpc3RlbnQ6IHRydWV9KVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAub24oJ2NoYW5nZScsIChldmVudCwgcGF0aDogc3RyaW5nKSA9PiB7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxsV2F0Y2hlcnMuZm9yRWFjaCgod2F0Y2hlcjogY2hva2lkYXIuRlNXYXRjaGVyKSA9PlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdhdGNoZXIuY2xvc2UoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFsbFdhdGNoZXJzID0gW107XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2F0Y2goYnVpbGRzKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgYWxsV2F0Y2hlcnMucHVzaChjb25maWdXYXRjaGVyKTtcclxuXHJcbiAgICBjb25zdCBjb25maWcgPSBNYXRlQ29uZmlnLmdldCgpO1xyXG5cclxuICAgIGNvbmZpZy5maWxlcy5mb3JFYWNoKChmaWxlKSA9PiB7XHJcbiAgICAgICAgZmlsZS5idWlsZHMuZm9yRWFjaCgoYnVpbGROYW1lKSA9PiB7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBpZiAoYnVpbGRzID09PSBudWxsIHx8IGJ1aWxkcy5pbmRleE9mKGJ1aWxkTmFtZSkgIT09IC0xKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3Qgd2F0Y2ggPSBjaG9raWRhci53YXRjaChmaWxlLmlucHV0LCB7IHBlcnNpc3RlbnQ6IHRydWV9KVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLm9uKCdjaGFuZ2UnLCAoZXZlbnQsIHBhdGg6IHN0cmluZykgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJ1bkZpbGVzKGNvbmZpZywgZmlsZSwgW2J1aWxkTmFtZV0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgYWxsV2F0Y2hlcnMucHVzaCh3YXRjaCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG4gICAgXHJcbiAgICBydW5CdWlsZChidWlsZHMpO1xyXG59XHJcblxyXG5leHBvcnQgY29uc3QgcnVuQnVpbGQgPSBmdW5jdGlvbihidWlsZHM/OiBzdHJpbmdbXSkge1xyXG5cclxuICAgIGNvbnN0IGNvbmZpZyA9IE1hdGVDb25maWcuZ2V0KCk7XHJcblxyXG4gICAgY29uZmlnLmZpbGVzLmZvckVhY2goKGZpbGUpOiB2b2lkID0+IHtcclxuICAgICAgICBcclxuICAgICAgICBydW5GaWxlcyhjb25maWcsIGZpbGUsIGJ1aWxkcyk7XHJcbiAgICB9KTtcclxufVxyXG5cclxuY29uc3QgcnVuRmlsZXMgPSBmdW5jdGlvbihjb25maWc6IE1hdGVDb25maWcsIGZpbGU6IE1hdGVDb25maWdGaWxlLCBidWlsZHM/OiBzdHJpbmdbXSkge1xyXG4gICAgXHJcbiAgICBpZiAoYnVpbGRzID09PSB1bmRlZmluZWQgfHwgKGJ1aWxkcyAhPT0gbnVsbCAmJiBidWlsZHMubGVuZ3RoID09PSAwKSlcclxuICAgICAgICBidWlsZHMgPSBbJ2RldiddO1xyXG5cclxuICAgIGZpbGUub3V0cHV0LmZvckVhY2goKG91dHB1dCkgPT4ge1xyXG4gICAgXHJcbiAgICAgICAgY29uc3Qgb3V0cHV0RXh0ZW50aW9uID0gb3V0cHV0LnNwbGl0KCcuJykucG9wKCkudG9Mb3dlckNhc2UoKTtcclxuICAgICAgICBjb25zdCBvdXRwdXRGaWxlTmFtZSA9IG91dHB1dC5yZXBsYWNlKC9eLipbXFxcXFxcL10vLCAnJyk7XHJcblxyXG4gICAgICAgIGZpbGUuYnVpbGRzLmZvckVhY2goKGJ1aWxkTmFtZSk6IHZvaWQgPT4ge1xyXG5cclxuICAgICAgICAgICAgaWYgKGJ1aWxkcyAhPT0gbnVsbCAmJiBidWlsZHMuaW5kZXhPZihidWlsZE5hbWUpID09PSAtMSlcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGJ1aWxkID0gY29uZmlnLmdldEJ1aWxkKGJ1aWxkTmFtZSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgICAgIGxldCBvdXRwdXREaXJlY3RvcnkgPSBidWlsZC5vdXREaXIgPyBidWlsZC5vdXREaXIgOiBwYXRoLmRpcm5hbWUob3V0cHV0KTtcclxuXHJcbiAgICAgICAgICAgIGlmIChidWlsZC5vdXREaXJWZXJzaW9uaW5nKVxyXG4gICAgICAgICAgICAgICAgb3V0cHV0RGlyZWN0b3J5ICs9ICcvJyArIGNvbmZpZy5nZXRPdXREaXJWZXJzaW9uKCk7XHJcblxyXG4gICAgICAgICAgICBpZiAoYnVpbGQub3V0RGlyTmFtZSlcclxuICAgICAgICAgICAgICAgIG91dHB1dERpcmVjdG9yeSArPSAnLycgKyBjb25maWcuZ2V0T3V0RGlyTmFtZSgpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgc3dpdGNoIChvdXRwdXRFeHRlbnRpb24pIHtcclxuXHJcbiAgICAgICAgICAgICAgICBjYXNlICdjc3MnOlxyXG4gICAgICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChidWlsZC5jc3Mub3V0RGlyU3VmZml4KVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBvdXRwdXREaXJlY3RvcnkgKz0gJy8nICsgYnVpbGQuY3NzLm91dERpclN1ZmZpeDtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcblxyXG4gICAgICAgICAgICAgICAgY2FzZSAnanMnOiBcclxuICAgICAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgICAgICBpZiAoYnVpbGQuanMub3V0RGlyU3VmZml4KVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBvdXRwdXREaXJlY3RvcnkgKz0gJy8nICsgYnVpbGQuanMub3V0RGlyU3VmZml4O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgaWYgKGJ1aWxkLnRzLmNvbXBpbGVyT3B0aW9ucy5kZWNsYXJhdGlvbiA9PT0gdHJ1ZSlcclxuICAgICAgICAgICAgICAgIGNyZWF0ZVR5cGVTY3JpcHREZWNsYXJhdGlvbihmaWxlLmlucHV0LCBvdXRwdXREaXJlY3RvcnksIG91dHB1dEZpbGVOYW1lLCBidWlsZCk7XHJcblxyXG4gICAgICAgICAgICBjb25zdCBwcm9jZXNzID0gYnVuZGxlKGZpbGUuaW5wdXQsIGJ1aWxkKVxyXG4gICAgICAgICAgICAucGlwZShndWxwQ29uY2F0KCdlbXB0eScpKVxyXG4gICAgICAgICAgICAucGlwZShndWxwUmVuYW1lKG91dHB1dEZpbGVOYW1lKSlcclxuICAgICAgICAgICAgLnBpcGUoZ3VscC5kZXN0KG91dHB1dERpcmVjdG9yeSkpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgc3dpdGNoIChvdXRwdXRFeHRlbnRpb24pIHtcclxuXHJcbiAgICAgICAgICAgICAgICBjYXNlICdjc3MnOlxyXG4gICAgICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChidWlsZC5jc3MubWluaWZ5KSB7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBwcm9jZXNzLnBpcGUoZ3VscENsZWFuQ1NTKCkpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC5waXBlKGd1bHBSZW5hbWUoe3N1ZmZpeDogXCIubWluXCJ9KSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgLnBpcGUoZ3VscC5kZXN0KG91dHB1dERpcmVjdG9yeSkpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuXHJcbiAgICAgICAgICAgICAgICBjYXNlICdqcyc6IFxyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGJ1aWxkLmpzLm1pbmlmeSkge1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgcHJvY2Vzcy5waXBlKGd1bHBVZ2xpZnkoKSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgLnBpcGUoZ3VscFJlbmFtZSh7c3VmZml4OiBcIi5taW5cIn0pKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAucGlwZShndWxwLmRlc3Qob3V0cHV0RGlyZWN0b3J5KSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgIH0pO1xyXG59Il19
