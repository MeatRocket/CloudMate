"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var config_1 = require("./config");
var chokidar = require("chokidar");
var gulp = require('gulp');
var gulpLess = require('gulp-less');
var gulpSass = require('gulp-sass');
var gulpRename = require('gulp-rename');
var gulpConcat = require("gulp-concat");
var gulpTs = require("gulp-typescript");
var gulpSourcemaps = require("gulp-sourcemaps");
var gulpMinify = require('gulp-minify');
var merge2 = require('merge2');
var gulpCleanCSS = require('gulp-clean-css');
var gulpFilter = require('gulp-filter-each');
var path = require('path');
var webClean = require('./webcleanjs');
var bundle = function (files, outputExtention, build) {
    var process = [];
    var groupFilesExtention = '';
    var groupedFiles = [];
    files.forEach(function (file) {
        var fileExtention = file.split('.').pop().toLowerCase();
        if (fileExtention !== groupFilesExtention) {
            if (groupedFiles.length > 0) {
                process.push(compile(groupedFiles, groupFilesExtention, outputExtention, build));
                groupedFiles = [];
            }
            groupFilesExtention = fileExtention;
        }
        groupedFiles.push(file);
    });
    if (groupedFiles.length > 0)
        process.push(compile(groupedFiles, groupFilesExtention, outputExtention, build));
    var stream = merge2();
    process.forEach(function (p) {
        stream.add(p);
    });
    return stream;
};
var compile = function (files, inputExtention, outputExtention, build) {
    var process = gulp.src(files);
    console.log(inputExtention + ' | ' + outputExtention);
    if (inputExtention === outputExtention)
        return process.pipe(gulpConcat('empty'));
    console.log(inputExtention + ' | ' + outputExtention);
    switch (inputExtention) {
        case 'css':
            return process.pipe(gulpConcat('empty'));
        case 'less':
            if (build.css.sourceMap)
                process = process.pipe(gulpSourcemaps.init());
            process = process.pipe(gulpLess());
            if (build.css.sourceMap)
                process = process.pipe(gulpSourcemaps.write());
            return process.pipe(gulpConcat('empty'));
        case 'scss':
            if (build.css.sourceMap)
                process = process.pipe(gulpSourcemaps.init());
            process = process.pipe(gulpSass().on('error', gulpSass.logError));
            if (build.css.sourceMap)
                process = process.pipe(gulpSourcemaps.write());
            return process.pipe(gulpConcat('empty'));
        case 'ts':
            if (build.js.sourceMap)
                process = process.pipe(gulpSourcemaps.init());
            process = process.pipe(gulpTs(build.ts.compilerOptions));
            if (build.js.sourceMap)
                process = process.pipe(gulpSourcemaps.write());
            return process.pipe(gulpConcat('empty'));
        case 'd.ts':
            return process.pipe(gulpTs(config_1.MateConfigTSConfig.declarationCompilerOptions(build.ts.compilerOptions)));
    }
    return process;
};
var createTypeScriptDeclaration = function (files, outputDirectory, outputFileName, build) {
    var typescriptDeclarations = [];
    files.forEach(function (file) {
        var fileExtention = file.split('.').pop().toLowerCase();
        if (fileExtention === 'ts' && !file.toLocaleLowerCase().endsWith('.d.ts'))
            typescriptDeclarations.push(file);
    });
    if (typescriptDeclarations.length > 0)
        compile(typescriptDeclarations, 'd.ts', 'ts', build)
            .pipe(gulpFilter(function (content, filepath) { return filepath.toLowerCase().endsWith('.d.ts'); }))
            .pipe(gulpConcat('empty'))
            .pipe(gulpRename({
            basename: outputFileName.replace('.js', ''),
            suffix: '.d',
            extname: '.ts'
        }))
            .pipe(gulp.dest(outputDirectory));
};
var allWatchers = [];
exports.watch = function (builds) {
    if (builds === undefined || (builds !== null && builds.length === 0))
        builds = ['dev'];
    var configWatcher = chokidar.watch('mateconfig.json', { persistent: true })
        .on('change', function (event, path) {
        allWatchers.forEach(function (watcher) {
            watcher.close();
        });
        allWatchers = [];
        exports.watch(builds);
    });
    allWatchers.push(configWatcher);
    var config = config_1.MateConfig.get();
    config.files.forEach(function (file) {
        file.builds.forEach(function (buildName) {
            if (builds === null || builds.indexOf(buildName) !== -1) {
                var extensions = ['less', 'scss'];
                var watchPaths_1 = [];
                file.input.forEach(function (path) {
                    watchPaths_1.push(path);
                });
                for (var _i = 0, extensions_1 = extensions; _i < extensions_1.length; _i++) {
                    var extension = extensions_1[_i];
                    if (config_1.MateConfigFile.hasExtension(file.input, extension))
                        watchPaths_1.push('./**/*.' + extension);
                }
                var watch_1 = chokidar.watch(watchPaths_1, { persistent: true })
                    .on('change', function (event, path) {
                    runFiles(config, file, [buildName]);
                });
                allWatchers.push(watch_1);
            }
        });
    });
    exports.runBuild(builds);
};
exports.runBuild = function (builds) {
    console.log('executed at ' + new Date().toTimeString());
    var config = config_1.MateConfig.get();
    config.files.forEach(function (file) {
        runFiles(config, file, builds);
    });
};
var runFiles = function (config, file, builds) {
    if (builds === undefined || (builds !== null && builds.length === 0))
        builds = ['dev'];
    file.output.forEach(function (output) {
        var outputExtention = output.split('.').pop().toLowerCase();
        var outputFileName = output.replace(/^.*[\\\/]/, '');
        file.builds.forEach(function (buildName) {
            if (builds !== null && builds.indexOf(buildName) === -1)
                return;
            var build = config.getBuild(buildName);
            var outputDirectory = build.outDir ? build.outDir : path.dirname(output);
            if (build.outDirVersioning)
                outputDirectory += '/' + config.getOutDirVersion();
            if (build.outDirName)
                outputDirectory += '/' + config.getOutDirName();
            switch (outputExtention) {
                case 'css':
                    if (build.css.outDirSuffix)
                        outputDirectory += '/' + build.css.outDirSuffix;
                    break;
                case 'js':
                    if (build.js.outDirSuffix)
                        outputDirectory += '/' + build.js.outDirSuffix;
                    break;
            }
            if (build.js.declaration === true)
                createTypeScriptDeclaration(file.input, outputDirectory, outputFileName, build);
            var process = bundle(file.input, outputExtention, build)
                .pipe(gulpConcat('empty'));
            switch (outputExtention) {
                case 'js':
                    if (build.js.webClean)
                        process = process.pipe(webClean());
                    break;
            }
            process = process.pipe(gulpRename(outputFileName))
                .pipe(gulp.dest(outputDirectory));
            switch (outputExtention) {
                case 'css':
                    if (build.css.minify) {
                        process.pipe(gulpCleanCSS())
                            .pipe(gulpRename({ suffix: ".min" }))
                            .pipe(gulp.dest(outputDirectory));
                    }
                    break;
                case 'js':
                    if (build.js.minify) {
                        process.pipe(gulpMinify({
                            ext: {
                                src: '.js',
                                min: '.min.js'
                            }
                        }))
                            .pipe(gulp.dest(outputDirectory));
                    }
                    break;
            }
        });
    });
};

//# sourceMappingURL=data:application/json;charset=utf8;base64,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LElBQUk7b0JBRUwsSUFBSSxLQUFLLENBQUMsRUFBRSxDQUFDLFFBQVE7d0JBQ2pCLE9BQU8sR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUM7b0JBQ3ZDLE1BQU07YUFDYjtZQUVELE9BQU8sR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxjQUFjLENBQUMsQ0FBQztpQkFDakQsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQztZQUV0QyxRQUFRLGVBQWUsRUFBRTtnQkFFckIsS0FBSyxLQUFLO29CQUVOLElBQUksS0FBSyxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUU7d0JBRWxCLE9BQU8sQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7NkJBQzNCLElBQUksQ0FBQyxVQUFVLENBQUMsRUFBQyxNQUFNLEVBQUUsTUFBTSxFQUFDLENBQUMsQ0FBQzs2QkFDbEMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQztxQkFDckM7b0JBQ0QsTUFBTTtnQkFFVixLQUFLLElBQUk7b0JBRUwsSUFBSSxLQUFLLENBQUMsRUFBRSxDQUFDLE1BQU0sRUFBRTt3QkFFakIsT0FBTyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUM7NEJBQ3BCLEdBQUcsRUFBQztnQ0FDQSxHQUFHLEVBQUMsS0FBSztnQ0FDVCxHQUFHLEVBQUMsU0FBUzs2QkFDaEI7eUJBQUMsQ0FBQyxDQUFDOzZCQUNQLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUM7cUJBQ3JDO29CQUNELE1BQU07YUFDYjtRQUVMLENBQUMsQ0FBQyxDQUFDO0lBRVAsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDLENBQUEiLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE1hdGVDb25maWcsIE1hdGVDb25maWdDU1NDb25maWcsIE1hdGVDb25maWdCdWlsZCwgTWF0ZUNvbmZpZ0ZpbGUsIE1hdGVDb25maWdUU0NvbmZpZyB9IGZyb20gXCIuL2NvbmZpZ1wiO1xyXG5pbXBvcnQgY2hva2lkYXIgPSByZXF1aXJlKCdjaG9raWRhcicpO1xyXG5cclxuY29uc3QgZ3VscCA9IHJlcXVpcmUoJ2d1bHAnKTtcclxuY29uc3QgZ3VscExlc3MgPSByZXF1aXJlKCdndWxwLWxlc3MnKTtcclxuY29uc3QgZ3VscFNhc3MgPSByZXF1aXJlKCdndWxwLXNhc3MnKTtcclxuY29uc3QgZ3VscFJlbmFtZSA9IHJlcXVpcmUoJ2d1bHAtcmVuYW1lJyk7XHJcbmNvbnN0IGd1bHBDb25jYXQgPSByZXF1aXJlKFwiZ3VscC1jb25jYXRcIik7XHJcbmNvbnN0IGd1bHBUcyA9IHJlcXVpcmUoXCJndWxwLXR5cGVzY3JpcHRcIik7XHJcbmNvbnN0IGd1bHBTb3VyY2VtYXBzID0gcmVxdWlyZShcImd1bHAtc291cmNlbWFwc1wiKTtcclxuY29uc3QgZ3VscE1pbmlmeSA9IHJlcXVpcmUoJ2d1bHAtbWluaWZ5Jyk7XHJcbmNvbnN0IG1lcmdlMiA9IHJlcXVpcmUoJ21lcmdlMicpO1xyXG5jb25zdCBndWxwQ2xlYW5DU1MgPSByZXF1aXJlKCdndWxwLWNsZWFuLWNzcycpO1xyXG5jb25zdCBndWxwRmlsdGVyID0gcmVxdWlyZSgnZ3VscC1maWx0ZXItZWFjaCcpO1xyXG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xyXG5jb25zdCB3ZWJDbGVhbiA9IHJlcXVpcmUoJy4vd2ViY2xlYW5qcycpO1xyXG5cclxuY29uc3QgYnVuZGxlID0gZnVuY3Rpb24oZmlsZXM6IHN0cmluZ1tdLCBvdXRwdXRFeHRlbnRpb246IHN0cmluZywgYnVpbGQ6IE1hdGVDb25maWdCdWlsZCk6IGFueSB7XHJcblxyXG4gICAgY29uc3QgcHJvY2VzczogYW55W10gPSBbXTtcclxuXHJcbiAgICBsZXQgZ3JvdXBGaWxlc0V4dGVudGlvbiA9ICcnO1xyXG4gICAgbGV0IGdyb3VwZWRGaWxlczogc3RyaW5nW10gPSBbXTtcclxuICAgIFxyXG4gICAgZmlsZXMuZm9yRWFjaCgoZmlsZSkgPT57XHJcblxyXG4gICAgICAgIGNvbnN0IGZpbGVFeHRlbnRpb24gPSBmaWxlLnNwbGl0KCcuJykucG9wKCkudG9Mb3dlckNhc2UoKTtcclxuXHJcbiAgICAgICAgaWYgKGZpbGVFeHRlbnRpb24gIT09IGdyb3VwRmlsZXNFeHRlbnRpb24pe1xyXG5cclxuICAgICAgICAgICAgaWYgKGdyb3VwZWRGaWxlcy5sZW5ndGggPiAwKVxyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICBwcm9jZXNzLnB1c2goY29tcGlsZShncm91cGVkRmlsZXMsIGdyb3VwRmlsZXNFeHRlbnRpb24sIG91dHB1dEV4dGVudGlvbiwgYnVpbGQpKTtcclxuICAgICAgICAgICAgICAgIGdyb3VwZWRGaWxlcyA9IFtdXHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGdyb3VwRmlsZXNFeHRlbnRpb24gPSBmaWxlRXh0ZW50aW9uO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgZ3JvdXBlZEZpbGVzLnB1c2goZmlsZSk7XHJcblxyXG4gICAgfSk7XHJcblxyXG4gICAgaWYgKGdyb3VwZWRGaWxlcy5sZW5ndGggPiAwKVxyXG4gICAgICAgIHByb2Nlc3MucHVzaChjb21waWxlKGdyb3VwZWRGaWxlcywgZ3JvdXBGaWxlc0V4dGVudGlvbiwgb3V0cHV0RXh0ZW50aW9uLCBidWlsZCkpO1xyXG5cclxuICAgY29uc3Qgc3RyZWFtID0gbWVyZ2UyKCk7XHJcblxyXG4gICBwcm9jZXNzLmZvckVhY2goKHApID0+e1xyXG4gICAgc3RyZWFtLmFkZChwKTtcclxuICAgfSk7XHJcbiAgICBcclxuICAgcmV0dXJuIHN0cmVhbTtcclxufVxyXG5cclxuY29uc3QgY29tcGlsZSA9IGZ1bmN0aW9uKGZpbGVzOiBzdHJpbmdbXSwgaW5wdXRFeHRlbnRpb246IHN0cmluZywgb3V0cHV0RXh0ZW50aW9uOiBzdHJpbmcsIGJ1aWxkOiBNYXRlQ29uZmlnQnVpbGQpOiBhbnkge1xyXG5cclxuICAgIGxldCBwcm9jZXNzID0gZ3VscC5zcmMoZmlsZXMpO1xyXG5cclxuICAgIGNvbnNvbGUubG9nKGlucHV0RXh0ZW50aW9uICsgJyB8ICcgKyBvdXRwdXRFeHRlbnRpb24pO1xyXG4gICAgXHJcbiAgICBpZiAoaW5wdXRFeHRlbnRpb24gPT09IG91dHB1dEV4dGVudGlvbilcclxuICAgICAgICByZXR1cm4gcHJvY2Vzcy5waXBlKGd1bHBDb25jYXQoJ2VtcHR5JykpO1xyXG5cclxuICAgIGNvbnNvbGUubG9nKGlucHV0RXh0ZW50aW9uICsgJyB8ICcgKyBvdXRwdXRFeHRlbnRpb24pO1xyXG5cclxuICAgIHN3aXRjaCAoaW5wdXRFeHRlbnRpb24pe1xyXG4gICAgICAgIGNhc2UgJ2Nzcyc6XHJcbiAgICAgICAgICAgIHJldHVybiBwcm9jZXNzLnBpcGUoZ3VscENvbmNhdCgnZW1wdHknKSk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgIGNhc2UgJ2xlc3MnOlxyXG5cclxuICAgICAgICAgICAgaWYgKGJ1aWxkLmNzcy5zb3VyY2VNYXApXHJcbiAgICAgICAgICAgICAgICBwcm9jZXNzID0gcHJvY2Vzcy5waXBlKGd1bHBTb3VyY2VtYXBzLmluaXQoKSk7XHJcblxyXG4gICAgICAgICAgICBwcm9jZXNzID0gcHJvY2Vzcy5waXBlKGd1bHBMZXNzKCkpOyAgICBcclxuXHJcbiAgICAgICAgICAgIGlmIChidWlsZC5jc3Muc291cmNlTWFwKVxyXG4gICAgICAgICAgICAgICAgcHJvY2VzcyA9IHByb2Nlc3MucGlwZShndWxwU291cmNlbWFwcy53cml0ZSgpKTtcclxuXHJcbiAgICAgICAgICAgIHJldHVybiBwcm9jZXNzLnBpcGUoZ3VscENvbmNhdCgnZW1wdHknKSk7XHJcblxyXG4gICAgICAgIGNhc2UgJ3Njc3MnOlxyXG5cclxuICAgICAgICAgICAgaWYgKGJ1aWxkLmNzcy5zb3VyY2VNYXApXHJcbiAgICAgICAgICAgICAgICBwcm9jZXNzID0gcHJvY2Vzcy5waXBlKGd1bHBTb3VyY2VtYXBzLmluaXQoKSk7XHJcblxyXG4gICAgICAgICAgICBwcm9jZXNzID0gcHJvY2Vzcy5waXBlKGd1bHBTYXNzKCkub24oJ2Vycm9yJywgZ3VscFNhc3MubG9nRXJyb3IpKTsgICAgXHJcblxyXG4gICAgICAgICAgICBpZiAoYnVpbGQuY3NzLnNvdXJjZU1hcClcclxuICAgICAgICAgICAgICAgIHByb2Nlc3MgPSBwcm9jZXNzLnBpcGUoZ3VscFNvdXJjZW1hcHMud3JpdGUoKSk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICByZXR1cm4gcHJvY2Vzcy5waXBlKGd1bHBDb25jYXQoJ2VtcHR5JykpO1xyXG4gICAgXHJcbiAgICAgICAgY2FzZSAndHMnOlxyXG5cclxuICAgICAgICAgICAgaWYgKGJ1aWxkLmpzLnNvdXJjZU1hcClcclxuICAgICAgICAgICAgICAgIHByb2Nlc3MgPSBwcm9jZXNzLnBpcGUoZ3VscFNvdXJjZW1hcHMuaW5pdCgpKTtcclxuXHJcbiAgICAgICAgICAgIHByb2Nlc3MgPSBwcm9jZXNzLnBpcGUoZ3VscFRzKGJ1aWxkLnRzLmNvbXBpbGVyT3B0aW9ucykpO1xyXG5cclxuICAgICAgICAgICAgaWYgKGJ1aWxkLmpzLnNvdXJjZU1hcClcclxuICAgICAgICAgICAgICAgIHByb2Nlc3MgPSBwcm9jZXNzLnBpcGUoZ3VscFNvdXJjZW1hcHMud3JpdGUoKSk7XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gcHJvY2Vzcy5waXBlKGd1bHBDb25jYXQoJ2VtcHR5JykpO1xyXG5cclxuICAgICAgICBjYXNlICdkLnRzJzpcclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICByZXR1cm4gcHJvY2Vzcy5waXBlKGd1bHBUcyhNYXRlQ29uZmlnVFNDb25maWcuZGVjbGFyYXRpb25Db21waWxlck9wdGlvbnMoYnVpbGQudHMuY29tcGlsZXJPcHRpb25zKSkpO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBwcm9jZXNzO1xyXG59XHJcblxyXG5jb25zdCBjcmVhdGVUeXBlU2NyaXB0RGVjbGFyYXRpb24gPSBmdW5jdGlvbihmaWxlczogc3RyaW5nIFtdLCBvdXRwdXREaXJlY3Rvcnk6IHN0cmluZywgb3V0cHV0RmlsZU5hbWU6IHN0cmluZywgYnVpbGQ6IE1hdGVDb25maWdCdWlsZCk6IHZvaWQge1xyXG5cclxuICAgIGNvbnN0IHR5cGVzY3JpcHREZWNsYXJhdGlvbnM6IHN0cmluZ1tdID0gW107XHJcbiAgICBcclxuICAgIGZpbGVzLmZvckVhY2goKGZpbGUpID0+IHtcclxuICAgICAgICBjb25zdCBmaWxlRXh0ZW50aW9uID0gZmlsZS5zcGxpdCgnLicpLnBvcCgpLnRvTG93ZXJDYXNlKCk7XHJcblxyXG4gICAgICAgIGlmIChmaWxlRXh0ZW50aW9uID09PSAndHMnICYmICFmaWxlLnRvTG9jYWxlTG93ZXJDYXNlKCkuZW5kc1dpdGgoJy5kLnRzJykpXHJcbiAgICAgICAgICAgIHR5cGVzY3JpcHREZWNsYXJhdGlvbnMucHVzaChmaWxlKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGlmICh0eXBlc2NyaXB0RGVjbGFyYXRpb25zLmxlbmd0aCA+IDApXHJcbiAgICAgICAgY29tcGlsZSh0eXBlc2NyaXB0RGVjbGFyYXRpb25zLCAnZC50cycsICd0cycsIGJ1aWxkKVxyXG4gICAgICAgICAgICAucGlwZShndWxwRmlsdGVyKChjb250ZW50LCBmaWxlcGF0aDogc3RyaW5nKSA9PiBmaWxlcGF0aC50b0xvd2VyQ2FzZSgpLmVuZHNXaXRoKCcuZC50cycpKSlcclxuICAgICAgICAgICAgLnBpcGUoZ3VscENvbmNhdCgnZW1wdHknKSlcclxuICAgICAgICAgICAgLnBpcGUoZ3VscFJlbmFtZSh7XHJcbiAgICAgICAgICAgICAgICBiYXNlbmFtZTogb3V0cHV0RmlsZU5hbWUucmVwbGFjZSgnLmpzJywgJycpLFxyXG4gICAgICAgICAgICAgICAgc3VmZml4OiAnLmQnLFxyXG4gICAgICAgICAgICAgICAgZXh0bmFtZTogJy50cydcclxuICAgICAgICAgICAgfSkpXHJcbiAgICAgICAgICAgIC5waXBlKGd1bHAuZGVzdChvdXRwdXREaXJlY3RvcnkpKTtcclxufVxyXG5cclxubGV0IGFsbFdhdGNoZXJzOiBjaG9raWRhci5GU1dhdGNoZXJbXSA9IFtdO1xyXG5cclxuZXhwb3J0IGNvbnN0IHdhdGNoID0gZnVuY3Rpb24oYnVpbGRzPzogc3RyaW5nW10pIHtcclxuXHJcbiAgICBpZiAoYnVpbGRzID09PSB1bmRlZmluZWQgfHwgKGJ1aWxkcyAhPT0gbnVsbCAmJiBidWlsZHMubGVuZ3RoID09PSAwKSlcclxuICAgICAgICBidWlsZHMgPSBbJ2RldiddO1xyXG5cclxuICAgIGNvbnN0IGNvbmZpZ1dhdGNoZXIgPSBjaG9raWRhci53YXRjaCgnbWF0ZWNvbmZpZy5qc29uJywgeyBwZXJzaXN0ZW50OiB0cnVlfSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLm9uKCdjaGFuZ2UnLCAoZXZlbnQsIHBhdGg6IHN0cmluZykgPT4ge1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFsbFdhdGNoZXJzLmZvckVhY2goKHdhdGNoZXI6IGNob2tpZGFyLkZTV2F0Y2hlcikgPT5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3YXRjaGVyLmNsb3NlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGxXYXRjaGVycyA9IFtdO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdhdGNoKGJ1aWxkcyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgIGFsbFdhdGNoZXJzLnB1c2goY29uZmlnV2F0Y2hlcik7XHJcblxyXG4gICAgY29uc3QgY29uZmlnID0gTWF0ZUNvbmZpZy5nZXQoKTtcclxuXHJcbiAgICBjb25maWcuZmlsZXMuZm9yRWFjaCgoZmlsZSkgPT4ge1xyXG4gICAgICAgIGZpbGUuYnVpbGRzLmZvckVhY2goKGJ1aWxkTmFtZSkgPT4ge1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgaWYgKGJ1aWxkcyA9PT0gbnVsbCB8fCBidWlsZHMuaW5kZXhPZihidWlsZE5hbWUpICE9PSAtMSkge1xyXG5cclxuICAgICAgICAgICAgICAgIGNvbnN0IGV4dGVuc2lvbnMgPSBbJ2xlc3MnLCAnc2NzcyddO1xyXG5cclxuICAgICAgICAgICAgICAgIGNvbnN0IHdhdGNoUGF0aHM6IHN0cmluZ1tdID0gW107XHJcblxyXG4gICAgICAgICAgICAgICAgZmlsZS5pbnB1dC5mb3JFYWNoKChwYXRoKSA9PntcclxuICAgICAgICAgICAgICAgICAgICB3YXRjaFBhdGhzLnB1c2gocGF0aCk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCBleHRlbnNpb24gb2YgZXh0ZW5zaW9ucylcclxuICAgICAgICAgICAgICAgICAgICBpZiAoTWF0ZUNvbmZpZ0ZpbGUuaGFzRXh0ZW5zaW9uKGZpbGUuaW5wdXQsIGV4dGVuc2lvbikpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHdhdGNoUGF0aHMucHVzaCgnLi8qKi8qLicgKyBleHRlbnNpb24pO1xyXG5cclxuICAgICAgICAgICAgICAgIGNvbnN0IHdhdGNoID0gY2hva2lkYXIud2F0Y2god2F0Y2hQYXRocywgeyBwZXJzaXN0ZW50OiB0cnVlfSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5vbignY2hhbmdlJywgKGV2ZW50LCBwYXRoOiBzdHJpbmcpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBydW5GaWxlcyhjb25maWcsIGZpbGUsIFtidWlsZE5hbWVdKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgIGFsbFdhdGNoZXJzLnB1c2god2F0Y2gpO1xyXG5cclxuICAgICAgICAgICAgICAgIC8vIGFwcGVuZFdhdGNoRm9ySW1wb3J0ZWRGaWxlcyhjb25maWcsIGZpbGUsIGJ1aWxkTmFtZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG4gICAgXHJcbiAgICBydW5CdWlsZChidWlsZHMpO1xyXG59XHJcblxyXG4vLyBjb25zdCBhcHBlbmRXYXRjaEZvckltcG9ydGVkRmlsZXMgPSBmdW5jdGlvbihjb25maWc6IE1hdGVDb25maWcsIGZpbGU6IE1hdGVDb25maWdGaWxlLCBidWlsZE5hbWU6IHN0cmluZyk6IHZvaWR7XHJcblxyXG4vLyAgICAgY29uc3QgZXh0ZW5zaW9ucyA9IFsnbGVzcycsICdzY3NzJ107XHJcblxyXG4vLyAgICAgZXh0ZW5zaW9ucy5mb3JFYWNoKChleHRlbnNpb246IHN0cmluZyk6IHZvaWQgPT4ge1xyXG5cclxuLy8gICAgICAgICBpZiAoIU1hdGVDb25maWdGaWxlLmhhc0V4dGVuc2lvbihmaWxlLmlucHV0LCBleHRlbnNpb24pKVxyXG4vLyAgICAgICAgICAgICByZXR1cm47XHJcbiAgICBcclxuLy8gICAgICAgICBjb25zdCB3YXRjaCA9IGNob2tpZGFyLndhdGNoKCcqKi8qLicgKyBleHRlbnNpb24sIHsgcGVyc2lzdGVudDogdHJ1ZX0pXHJcbi8vICAgICAgICAgICAgICAgICAgICAgICAgICAgICAub24oJ2NoYW5nZScsIChldmVudCwgcGF0aDogc3RyaW5nKSA9PiB7XHJcbi8vICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcnVuRmlsZXMoY29uZmlnLCBmaWxlLCBbYnVpbGROYW1lXSk7XHJcbi8vICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuXHJcbi8vICAgICAgICAgYWxsV2F0Y2hlcnMucHVzaCh3YXRjaCk7XHJcbi8vICAgICB9KTtcclxuLy8gfVxyXG5cclxuZXhwb3J0IGNvbnN0IHJ1bkJ1aWxkID0gZnVuY3Rpb24oYnVpbGRzPzogc3RyaW5nW10pIHtcclxuXHJcbiAgICBjb25zb2xlLmxvZygnZXhlY3V0ZWQgYXQgJyArIG5ldyBEYXRlKCkudG9UaW1lU3RyaW5nKCkpO1xyXG4gICAgXHJcbiAgICBjb25zdCBjb25maWcgPSBNYXRlQ29uZmlnLmdldCgpO1xyXG5cclxuICAgIGNvbmZpZy5maWxlcy5mb3JFYWNoKChmaWxlKTogdm9pZCA9PiB7XHJcbiAgICAgICAgXHJcbiAgICAgICAgcnVuRmlsZXMoY29uZmlnLCBmaWxlLCBidWlsZHMpO1xyXG4gICAgfSk7XHJcbn1cclxuXHJcbmNvbnN0IHJ1bkZpbGVzID0gZnVuY3Rpb24oY29uZmlnOiBNYXRlQ29uZmlnLCBmaWxlOiBNYXRlQ29uZmlnRmlsZSwgYnVpbGRzPzogc3RyaW5nW10pIHtcclxuICAgIFxyXG4gICAgaWYgKGJ1aWxkcyA9PT0gdW5kZWZpbmVkIHx8IChidWlsZHMgIT09IG51bGwgJiYgYnVpbGRzLmxlbmd0aCA9PT0gMCkpXHJcbiAgICAgICAgYnVpbGRzID0gWydkZXYnXTtcclxuXHJcbiAgICBmaWxlLm91dHB1dC5mb3JFYWNoKChvdXRwdXQpID0+IHtcclxuICAgIFxyXG4gICAgICAgIGNvbnN0IG91dHB1dEV4dGVudGlvbiA9IG91dHB1dC5zcGxpdCgnLicpLnBvcCgpLnRvTG93ZXJDYXNlKCk7XHJcbiAgICAgICAgY29uc3Qgb3V0cHV0RmlsZU5hbWUgPSBvdXRwdXQucmVwbGFjZSgvXi4qW1xcXFxcXC9dLywgJycpO1xyXG5cclxuICAgICAgICBmaWxlLmJ1aWxkcy5mb3JFYWNoKChidWlsZE5hbWUpOiB2b2lkID0+IHtcclxuXHJcbiAgICAgICAgICAgIGlmIChidWlsZHMgIT09IG51bGwgJiYgYnVpbGRzLmluZGV4T2YoYnVpbGROYW1lKSA9PT0gLTEpXHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcblxyXG4gICAgICAgICAgICBjb25zdCBidWlsZCA9IGNvbmZpZy5nZXRCdWlsZChidWlsZE5hbWUpO1xyXG4gICAgICAgIFxyXG4gICAgICAgICAgICBsZXQgb3V0cHV0RGlyZWN0b3J5ID0gYnVpbGQub3V0RGlyID8gYnVpbGQub3V0RGlyIDogcGF0aC5kaXJuYW1lKG91dHB1dCk7XHJcblxyXG4gICAgICAgICAgICBpZiAoYnVpbGQub3V0RGlyVmVyc2lvbmluZylcclxuICAgICAgICAgICAgICAgIG91dHB1dERpcmVjdG9yeSArPSAnLycgKyBjb25maWcuZ2V0T3V0RGlyVmVyc2lvbigpO1xyXG5cclxuICAgICAgICAgICAgaWYgKGJ1aWxkLm91dERpck5hbWUpXHJcbiAgICAgICAgICAgICAgICBvdXRwdXREaXJlY3RvcnkgKz0gJy8nICsgY29uZmlnLmdldE91dERpck5hbWUoKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIHN3aXRjaCAob3V0cHV0RXh0ZW50aW9uKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgY2FzZSAnY3NzJzpcclxuICAgICAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgICAgICBpZiAoYnVpbGQuY3NzLm91dERpclN1ZmZpeClcclxuICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0RGlyZWN0b3J5ICs9ICcvJyArIGJ1aWxkLmNzcy5vdXREaXJTdWZmaXg7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG5cclxuICAgICAgICAgICAgICAgIGNhc2UgJ2pzJzogXHJcbiAgICAgICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGJ1aWxkLmpzLm91dERpclN1ZmZpeClcclxuICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0RGlyZWN0b3J5ICs9ICcvJyArIGJ1aWxkLmpzLm91dERpclN1ZmZpeDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGlmIChidWlsZC5qcy5kZWNsYXJhdGlvbiA9PT0gdHJ1ZSlcclxuICAgICAgICAgICAgICAgIGNyZWF0ZVR5cGVTY3JpcHREZWNsYXJhdGlvbihmaWxlLmlucHV0LCBvdXRwdXREaXJlY3RvcnksIG91dHB1dEZpbGVOYW1lLCBidWlsZCk7XHJcblxyXG4gICAgICAgICAgICAgICAgbGV0IHByb2Nlc3MgPSBidW5kbGUoZmlsZS5pbnB1dCwgb3V0cHV0RXh0ZW50aW9uLCBidWlsZClcclxuICAgICAgICAgICAgICAgIC5waXBlKGd1bHBDb25jYXQoJ2VtcHR5JykpXHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgc3dpdGNoIChvdXRwdXRFeHRlbnRpb24pIHtcclxuICAgIFxyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ2pzJzogXHJcbiAgICAgICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChidWlsZC5qcy53ZWJDbGVhbilcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb2Nlc3MgPSBwcm9jZXNzLnBpcGUod2ViQ2xlYW4oKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIHByb2Nlc3MgPSBwcm9jZXNzLnBpcGUoZ3VscFJlbmFtZShvdXRwdXRGaWxlTmFtZSkpXHJcbiAgICAgICAgICAgICAgICAucGlwZShndWxwLmRlc3Qob3V0cHV0RGlyZWN0b3J5KSk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBzd2l0Y2ggKG91dHB1dEV4dGVudGlvbikge1xyXG5cclxuICAgICAgICAgICAgICAgIGNhc2UgJ2Nzcyc6XHJcbiAgICAgICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGJ1aWxkLmNzcy5taW5pZnkpIHtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb2Nlc3MucGlwZShndWxwQ2xlYW5DU1MoKSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgLnBpcGUoZ3VscFJlbmFtZSh7c3VmZml4OiBcIi5taW5cIn0pKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAucGlwZShndWxwLmRlc3Qob3V0cHV0RGlyZWN0b3J5KSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG5cclxuICAgICAgICAgICAgICAgIGNhc2UgJ2pzJzogXHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgICAgICBpZiAoYnVpbGQuanMubWluaWZ5KSB7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBwcm9jZXNzLnBpcGUoZ3VscE1pbmlmeSh7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBleHQ6e1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNyYzonLmpzJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtaW46Jy5taW4uanMnXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9fSkpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC5waXBlKGd1bHAuZGVzdChvdXRwdXREaXJlY3RvcnkpKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgfSk7XHJcbn0iXX0=
