"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var config_1 = require("./config");
var chokidar = require("chokidar");
var gulp = require('gulp');
var gulpLess = require('gulp-less');
var gulpSass = require('gulp-sass');
var gulpRename = require('gulp-rename');
var gulpConcat = require("gulp-concat");
var gulpTs = require("gulp-typescript");
var gulpSourcemaps = require("gulp-sourcemaps");
var gulpMinify = require('gulp-minify');
var merge2 = require('merge2');
var gulpCleanCSS = require('gulp-clean-css');
var gulpFilter = require('gulp-filter-each');
var path = require('path');
var webClean = require('./webcleanjs');
var bundle = function (files, outputExtention, build) {
    var process = [];
    var groupFilesExtention = '';
    var groupedFiles = [];
    files.forEach(function (file) {
        var fileExtention = file.split('.').pop().toLowerCase();
        if (fileExtention !== groupFilesExtention) {
            if (groupedFiles.length > 0) {
                process.push(compile(groupedFiles, groupFilesExtention, outputExtention, build));
                groupedFiles = [];
            }
            groupFilesExtention = fileExtention;
        }
        groupedFiles.push(file);
    });
    if (groupedFiles.length > 0)
        process.push(compile(groupedFiles, groupFilesExtention, outputExtention, build));
    var stream = merge2();
    process.forEach(function (p) {
        stream.add(p);
    });
    return stream;
};
var compile = function (files, inputExtention, outputExtention, build) {
    var process = gulp.src(files);
    if (inputExtention === outputExtention)
        return process.pipe(gulpConcat('empty'));
    switch (inputExtention) {
        case 'css':
            return process.pipe(gulpConcat('empty'));
        case 'less':
            if (build.css.sourceMap)
                process = process.pipe(gulpSourcemaps.init());
            process = process.pipe(gulpLess());
            if (build.css.sourceMap)
                process = process.pipe(gulpSourcemaps.write());
            return process.pipe(gulpConcat('empty'));
        case 'scss':
            if (build.css.sourceMap)
                process = process.pipe(gulpSourcemaps.init());
            process = process.pipe(gulpSass().on('error', gulpSass.logError));
            if (build.css.sourceMap)
                process = process.pipe(gulpSourcemaps.write());
            return process.pipe(gulpConcat('empty'));
        case 'ts':
            if (build.js.sourceMap)
                process = process.pipe(gulpSourcemaps.init());
            process = process.pipe(gulpTs(build.ts.compilerOptions));
            if (outputExtention === 'js' && build.js.webClean)
                process = process.pipe(webClean());
            if (build.js.sourceMap)
                process = process.pipe(gulpSourcemaps.write());
            return process.pipe(gulpConcat('empty'));
        case 'd.ts':
            return process.pipe(gulpTs(config_1.MateConfigTSConfig.declarationCompilerOptions(build.ts.compilerOptions)));
    }
    return process;
};
var createTypeScriptDeclaration = function (files, outputDirectory, outputFileName, build) {
    var typescriptDeclarations = [];
    files.forEach(function (file) {
        var fileExtention = file.split('.').pop().toLowerCase();
        if (fileExtention === 'ts' && !file.toLocaleLowerCase().endsWith('.d.ts'))
            typescriptDeclarations.push(file);
    });
    if (typescriptDeclarations.length > 0)
        compile(typescriptDeclarations, 'd.ts', 'ts', build)
            .pipe(gulpFilter(function (content, filepath) { return filepath.toLowerCase().endsWith('.d.ts'); }))
            .pipe(gulpConcat('empty'))
            .pipe(webClean({ isDeclaration: true }))
            .pipe(gulpRename({
            basename: outputFileName.replace('.js', ''),
            suffix: '.d',
            extname: '.ts'
        }))
            .pipe(gulp.dest(outputDirectory));
};
var allWatchers = [];
exports.watch = function (builds) {
    if (builds === undefined || (builds !== null && builds.length === 0))
        builds = ['dev'];
    var configWatcher = chokidar.watch('mateconfig.json', { persistent: true })
        .on('change', function (event, path) {
        allWatchers.forEach(function (watcher) {
            watcher.close();
        });
        allWatchers = [];
        exports.watch(builds);
    });
    allWatchers.push(configWatcher);
    var config = config_1.MateConfig.get();
    config.files.forEach(function (file) {
        file.builds.forEach(function (buildName) {
            if (builds === null || builds.indexOf(buildName) !== -1) {
                var extensions = ['less', 'scss'];
                var watchPaths_1 = [];
                file.input.forEach(function (path) {
                    watchPaths_1.push(path);
                });
                for (var _i = 0, extensions_1 = extensions; _i < extensions_1.length; _i++) {
                    var extension = extensions_1[_i];
                    if (config_1.MateConfigFile.hasExtension(file.input, extension))
                        watchPaths_1.push('./**/*.' + extension);
                }
                var watch_1 = chokidar.watch(watchPaths_1, { persistent: true })
                    .on('change', function (event, path) {
                    runFiles(config, file, [buildName]);
                });
                allWatchers.push(watch_1);
            }
        });
    });
    exports.runBuild(builds);
};
exports.runBuild = function (builds) {
    console.log('executed at ' + new Date().toTimeString());
    var config = config_1.MateConfig.get();
    config.files.forEach(function (file) {
        runFiles(config, file, builds);
    });
};
var runFiles = function (config, file, builds) {
    if (builds === undefined || (builds !== null && builds.length === 0))
        builds = ['dev'];
    file.output.forEach(function (output) {
        var outputExtention = output.split('.').pop().toLowerCase();
        var outputFileName = output.replace(/^.*[\\\/]/, '');
        file.builds.forEach(function (buildName) {
            if (builds !== null && builds.indexOf(buildName) === -1)
                return;
            var build = config.getBuild(buildName);
            var outputDirectory = build.outDir ? build.outDir : path.dirname(output);
            if (build.outDirVersioning)
                outputDirectory += '/' + config.getOutDirVersion();
            if (build.outDirName)
                outputDirectory += '/' + config.getOutDirName();
            switch (outputExtention) {
                case 'css':
                    if (build.css.outDirSuffix)
                        outputDirectory += '/' + build.css.outDirSuffix;
                    break;
                case 'js':
                    if (build.js.outDirSuffix)
                        outputDirectory += '/' + build.js.outDirSuffix;
                    break;
            }
            if (build.js.declaration === true)
                createTypeScriptDeclaration(file.input, outputDirectory, outputFileName, build);
            var process = bundle(file.input, outputExtention, build)
                .pipe(gulpConcat('empty'));
            process = process.pipe(gulpRename(outputFileName))
                .pipe(gulp.dest(outputDirectory));
            switch (outputExtention) {
                case 'css':
                    if (build.css.minify) {
                        process.pipe(gulpCleanCSS())
                            .pipe(gulpRename({ suffix: ".min" }))
                            .pipe(gulp.dest(outputDirectory));
                    }
                    break;
                case 'js':
                    if (build.js.minify) {
                        process.pipe(gulpMinify({
                            ext: {
                                src: '.js',
                                min: '.min.js'
                            }
                        }))
                            .pipe(gulp.dest(outputDirectory));
                    }
                    break;
            }
        });
    });
};

//# sourceMappingURL=data:application/json;charset=utf8;base64,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T0FBTyxDQUFDLENBQUMsQ0FBQTtZQUUxQixPQUFPLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsY0FBYyxDQUFDLENBQUM7aUJBQ2pELElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUM7WUFFdEMsUUFBUSxlQUFlLEVBQUU7Z0JBRXJCLEtBQUssS0FBSztvQkFFTixJQUFJLEtBQUssQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFO3dCQUVsQixPQUFPLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDOzZCQUMzQixJQUFJLENBQUMsVUFBVSxDQUFDLEVBQUMsTUFBTSxFQUFFLE1BQU0sRUFBQyxDQUFDLENBQUM7NkJBQ2xDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUM7cUJBQ3JDO29CQUNELE1BQU07Z0JBRVYsS0FBSyxJQUFJO29CQUVMLElBQUksS0FBSyxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUU7d0JBRWpCLE9BQU8sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDOzRCQUNwQixHQUFHLEVBQUM7Z0NBQ0EsR0FBRyxFQUFDLEtBQUs7Z0NBQ1QsR0FBRyxFQUFDLFNBQVM7NkJBQ2hCO3lCQUFDLENBQUMsQ0FBQzs2QkFDUCxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDO3FCQUNyQztvQkFDRCxNQUFNO2FBQ2I7UUFFTCxDQUFDLENBQUMsQ0FBQztJQUVQLENBQUMsQ0FBQyxDQUFDO0FBQ1AsQ0FBQyxDQUFBIiwiZmlsZSI6Im1haW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBNYXRlQ29uZmlnLCBNYXRlQ29uZmlnQ1NTQ29uZmlnLCBNYXRlQ29uZmlnQnVpbGQsIE1hdGVDb25maWdGaWxlLCBNYXRlQ29uZmlnVFNDb25maWcgfSBmcm9tIFwiLi9jb25maWdcIjtcclxuaW1wb3J0IGNob2tpZGFyID0gcmVxdWlyZSgnY2hva2lkYXInKTtcclxuXHJcbmNvbnN0IGd1bHAgPSByZXF1aXJlKCdndWxwJyk7XHJcbmNvbnN0IGd1bHBMZXNzID0gcmVxdWlyZSgnZ3VscC1sZXNzJyk7XHJcbmNvbnN0IGd1bHBTYXNzID0gcmVxdWlyZSgnZ3VscC1zYXNzJyk7XHJcbmNvbnN0IGd1bHBSZW5hbWUgPSByZXF1aXJlKCdndWxwLXJlbmFtZScpO1xyXG5jb25zdCBndWxwQ29uY2F0ID0gcmVxdWlyZShcImd1bHAtY29uY2F0XCIpO1xyXG5jb25zdCBndWxwVHMgPSByZXF1aXJlKFwiZ3VscC10eXBlc2NyaXB0XCIpO1xyXG5jb25zdCBndWxwU291cmNlbWFwcyA9IHJlcXVpcmUoXCJndWxwLXNvdXJjZW1hcHNcIik7XHJcbmNvbnN0IGd1bHBNaW5pZnkgPSByZXF1aXJlKCdndWxwLW1pbmlmeScpO1xyXG5jb25zdCBtZXJnZTIgPSByZXF1aXJlKCdtZXJnZTInKTtcclxuY29uc3QgZ3VscENsZWFuQ1NTID0gcmVxdWlyZSgnZ3VscC1jbGVhbi1jc3MnKTtcclxuY29uc3QgZ3VscEZpbHRlciA9IHJlcXVpcmUoJ2d1bHAtZmlsdGVyLWVhY2gnKTtcclxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcclxuY29uc3Qgd2ViQ2xlYW4gPSByZXF1aXJlKCcuL3dlYmNsZWFuanMnKTtcclxuXHJcbmNvbnN0IGJ1bmRsZSA9IGZ1bmN0aW9uKGZpbGVzOiBzdHJpbmdbXSwgb3V0cHV0RXh0ZW50aW9uOiBzdHJpbmcsIGJ1aWxkOiBNYXRlQ29uZmlnQnVpbGQpOiBhbnkge1xyXG5cclxuICAgIGNvbnN0IHByb2Nlc3M6IGFueVtdID0gW107XHJcblxyXG4gICAgbGV0IGdyb3VwRmlsZXNFeHRlbnRpb24gPSAnJztcclxuICAgIGxldCBncm91cGVkRmlsZXM6IHN0cmluZ1tdID0gW107XHJcbiAgICBcclxuICAgIGZpbGVzLmZvckVhY2goKGZpbGUpID0+e1xyXG5cclxuICAgICAgICBjb25zdCBmaWxlRXh0ZW50aW9uID0gZmlsZS5zcGxpdCgnLicpLnBvcCgpLnRvTG93ZXJDYXNlKCk7XHJcblxyXG4gICAgICAgIGlmIChmaWxlRXh0ZW50aW9uICE9PSBncm91cEZpbGVzRXh0ZW50aW9uKXtcclxuXHJcbiAgICAgICAgICAgIGlmIChncm91cGVkRmlsZXMubGVuZ3RoID4gMClcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgcHJvY2Vzcy5wdXNoKGNvbXBpbGUoZ3JvdXBlZEZpbGVzLCBncm91cEZpbGVzRXh0ZW50aW9uLCBvdXRwdXRFeHRlbnRpb24sIGJ1aWxkKSk7XHJcbiAgICAgICAgICAgICAgICBncm91cGVkRmlsZXMgPSBbXVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBncm91cEZpbGVzRXh0ZW50aW9uID0gZmlsZUV4dGVudGlvbjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGdyb3VwZWRGaWxlcy5wdXNoKGZpbGUpO1xyXG5cclxuICAgIH0pO1xyXG5cclxuICAgIGlmIChncm91cGVkRmlsZXMubGVuZ3RoID4gMClcclxuICAgICAgICBwcm9jZXNzLnB1c2goY29tcGlsZShncm91cGVkRmlsZXMsIGdyb3VwRmlsZXNFeHRlbnRpb24sIG91dHB1dEV4dGVudGlvbiwgYnVpbGQpKTtcclxuXHJcbiAgIGNvbnN0IHN0cmVhbSA9IG1lcmdlMigpO1xyXG5cclxuICAgcHJvY2Vzcy5mb3JFYWNoKChwKSA9PntcclxuICAgIHN0cmVhbS5hZGQocCk7XHJcbiAgIH0pO1xyXG4gICAgXHJcbiAgIHJldHVybiBzdHJlYW07XHJcbn1cclxuXHJcbmNvbnN0IGNvbXBpbGUgPSBmdW5jdGlvbihmaWxlczogc3RyaW5nW10sIGlucHV0RXh0ZW50aW9uOiBzdHJpbmcsIG91dHB1dEV4dGVudGlvbjogc3RyaW5nLCBidWlsZDogTWF0ZUNvbmZpZ0J1aWxkKTogYW55IHtcclxuXHJcbiAgICBsZXQgcHJvY2VzcyA9IGd1bHAuc3JjKGZpbGVzKTtcclxuICAgIFxyXG4gICAgaWYgKGlucHV0RXh0ZW50aW9uID09PSBvdXRwdXRFeHRlbnRpb24pXHJcbiAgICAgICAgcmV0dXJuIHByb2Nlc3MucGlwZShndWxwQ29uY2F0KCdlbXB0eScpKTtcclxuXHJcbiAgICBzd2l0Y2ggKGlucHV0RXh0ZW50aW9uKXtcclxuICAgICAgICBjYXNlICdjc3MnOlxyXG4gICAgICAgICAgICByZXR1cm4gcHJvY2Vzcy5waXBlKGd1bHBDb25jYXQoJ2VtcHR5JykpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICBjYXNlICdsZXNzJzpcclxuXHJcbiAgICAgICAgICAgIGlmIChidWlsZC5jc3Muc291cmNlTWFwKVxyXG4gICAgICAgICAgICAgICAgcHJvY2VzcyA9IHByb2Nlc3MucGlwZShndWxwU291cmNlbWFwcy5pbml0KCkpO1xyXG5cclxuICAgICAgICAgICAgcHJvY2VzcyA9IHByb2Nlc3MucGlwZShndWxwTGVzcygpKTsgICAgXHJcblxyXG4gICAgICAgICAgICBpZiAoYnVpbGQuY3NzLnNvdXJjZU1hcClcclxuICAgICAgICAgICAgICAgIHByb2Nlc3MgPSBwcm9jZXNzLnBpcGUoZ3VscFNvdXJjZW1hcHMud3JpdGUoKSk7XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gcHJvY2Vzcy5waXBlKGd1bHBDb25jYXQoJ2VtcHR5JykpO1xyXG5cclxuICAgICAgICBjYXNlICdzY3NzJzpcclxuXHJcbiAgICAgICAgICAgIGlmIChidWlsZC5jc3Muc291cmNlTWFwKVxyXG4gICAgICAgICAgICAgICAgcHJvY2VzcyA9IHByb2Nlc3MucGlwZShndWxwU291cmNlbWFwcy5pbml0KCkpO1xyXG5cclxuICAgICAgICAgICAgcHJvY2VzcyA9IHByb2Nlc3MucGlwZShndWxwU2FzcygpLm9uKCdlcnJvcicsIGd1bHBTYXNzLmxvZ0Vycm9yKSk7ICAgIFxyXG5cclxuICAgICAgICAgICAgaWYgKGJ1aWxkLmNzcy5zb3VyY2VNYXApXHJcbiAgICAgICAgICAgICAgICBwcm9jZXNzID0gcHJvY2Vzcy5waXBlKGd1bHBTb3VyY2VtYXBzLndyaXRlKCkpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgcmV0dXJuIHByb2Nlc3MucGlwZShndWxwQ29uY2F0KCdlbXB0eScpKTtcclxuICAgIFxyXG4gICAgICAgIGNhc2UgJ3RzJzpcclxuXHJcbiAgICAgICAgICAgIGlmIChidWlsZC5qcy5zb3VyY2VNYXApXHJcbiAgICAgICAgICAgICAgICBwcm9jZXNzID0gcHJvY2Vzcy5waXBlKGd1bHBTb3VyY2VtYXBzLmluaXQoKSk7XHJcblxyXG4gICAgICAgICAgICBwcm9jZXNzID0gcHJvY2Vzcy5waXBlKGd1bHBUcyhidWlsZC50cy5jb21waWxlck9wdGlvbnMpKTtcclxuXHJcbiAgICAgICAgICAgIGlmIChvdXRwdXRFeHRlbnRpb24gPT09ICdqcycgJiYgYnVpbGQuanMud2ViQ2xlYW4pXHJcbiAgICAgICAgICAgICAgICBwcm9jZXNzID0gcHJvY2Vzcy5waXBlKHdlYkNsZWFuKCkpO1xyXG5cclxuICAgICAgICAgICAgaWYgKGJ1aWxkLmpzLnNvdXJjZU1hcClcclxuICAgICAgICAgICAgICAgIHByb2Nlc3MgPSBwcm9jZXNzLnBpcGUoZ3VscFNvdXJjZW1hcHMud3JpdGUoKSk7XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gcHJvY2Vzcy5waXBlKGd1bHBDb25jYXQoJ2VtcHR5JykpO1xyXG5cclxuICAgICAgICBjYXNlICdkLnRzJzpcclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICByZXR1cm4gcHJvY2Vzcy5waXBlKGd1bHBUcyhNYXRlQ29uZmlnVFNDb25maWcuZGVjbGFyYXRpb25Db21waWxlck9wdGlvbnMoYnVpbGQudHMuY29tcGlsZXJPcHRpb25zKSkpO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBwcm9jZXNzO1xyXG59XHJcblxyXG5jb25zdCBjcmVhdGVUeXBlU2NyaXB0RGVjbGFyYXRpb24gPSBmdW5jdGlvbihmaWxlczogc3RyaW5nIFtdLCBvdXRwdXREaXJlY3Rvcnk6IHN0cmluZywgb3V0cHV0RmlsZU5hbWU6IHN0cmluZywgYnVpbGQ6IE1hdGVDb25maWdCdWlsZCk6IHZvaWQge1xyXG5cclxuICAgIGNvbnN0IHR5cGVzY3JpcHREZWNsYXJhdGlvbnM6IHN0cmluZ1tdID0gW107XHJcbiAgICBcclxuICAgIGZpbGVzLmZvckVhY2goKGZpbGUpID0+IHtcclxuICAgICAgICBjb25zdCBmaWxlRXh0ZW50aW9uID0gZmlsZS5zcGxpdCgnLicpLnBvcCgpLnRvTG93ZXJDYXNlKCk7XHJcblxyXG4gICAgICAgIGlmIChmaWxlRXh0ZW50aW9uID09PSAndHMnICYmICFmaWxlLnRvTG9jYWxlTG93ZXJDYXNlKCkuZW5kc1dpdGgoJy5kLnRzJykpXHJcbiAgICAgICAgICAgIHR5cGVzY3JpcHREZWNsYXJhdGlvbnMucHVzaChmaWxlKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGlmICh0eXBlc2NyaXB0RGVjbGFyYXRpb25zLmxlbmd0aCA+IDApXHJcbiAgICAgICAgY29tcGlsZSh0eXBlc2NyaXB0RGVjbGFyYXRpb25zLCAnZC50cycsICd0cycsIGJ1aWxkKVxyXG4gICAgICAgICAgICAucGlwZShndWxwRmlsdGVyKChjb250ZW50LCBmaWxlcGF0aDogc3RyaW5nKSA9PiBmaWxlcGF0aC50b0xvd2VyQ2FzZSgpLmVuZHNXaXRoKCcuZC50cycpKSlcclxuICAgICAgICAgICAgLnBpcGUoZ3VscENvbmNhdCgnZW1wdHknKSlcclxuICAgICAgICAgICAgLnBpcGUod2ViQ2xlYW4oe2lzRGVjbGFyYXRpb246IHRydWV9KSlcclxuICAgICAgICAgICAgLnBpcGUoZ3VscFJlbmFtZSh7XHJcbiAgICAgICAgICAgICAgICBiYXNlbmFtZTogb3V0cHV0RmlsZU5hbWUucmVwbGFjZSgnLmpzJywgJycpLFxyXG4gICAgICAgICAgICAgICAgc3VmZml4OiAnLmQnLFxyXG4gICAgICAgICAgICAgICAgZXh0bmFtZTogJy50cydcclxuICAgICAgICAgICAgfSkpXHJcbiAgICAgICAgICAgIC5waXBlKGd1bHAuZGVzdChvdXRwdXREaXJlY3RvcnkpKTtcclxufVxyXG5cclxubGV0IGFsbFdhdGNoZXJzOiBjaG9raWRhci5GU1dhdGNoZXJbXSA9IFtdO1xyXG5cclxuZXhwb3J0IGNvbnN0IHdhdGNoID0gZnVuY3Rpb24oYnVpbGRzPzogc3RyaW5nW10pIHtcclxuXHJcbiAgICBpZiAoYnVpbGRzID09PSB1bmRlZmluZWQgfHwgKGJ1aWxkcyAhPT0gbnVsbCAmJiBidWlsZHMubGVuZ3RoID09PSAwKSlcclxuICAgICAgICBidWlsZHMgPSBbJ2RldiddO1xyXG5cclxuICAgIGNvbnN0IGNvbmZpZ1dhdGNoZXIgPSBjaG9raWRhci53YXRjaCgnbWF0ZWNvbmZpZy5qc29uJywgeyBwZXJzaXN0ZW50OiB0cnVlfSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLm9uKCdjaGFuZ2UnLCAoZXZlbnQsIHBhdGg6IHN0cmluZykgPT4ge1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFsbFdhdGNoZXJzLmZvckVhY2goKHdhdGNoZXI6IGNob2tpZGFyLkZTV2F0Y2hlcikgPT5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3YXRjaGVyLmNsb3NlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGxXYXRjaGVycyA9IFtdO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdhdGNoKGJ1aWxkcyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgIGFsbFdhdGNoZXJzLnB1c2goY29uZmlnV2F0Y2hlcik7XHJcblxyXG4gICAgY29uc3QgY29uZmlnID0gTWF0ZUNvbmZpZy5nZXQoKTtcclxuXHJcbiAgICBjb25maWcuZmlsZXMuZm9yRWFjaCgoZmlsZSkgPT4ge1xyXG4gICAgICAgIGZpbGUuYnVpbGRzLmZvckVhY2goKGJ1aWxkTmFtZSkgPT4ge1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgaWYgKGJ1aWxkcyA9PT0gbnVsbCB8fCBidWlsZHMuaW5kZXhPZihidWlsZE5hbWUpICE9PSAtMSkge1xyXG5cclxuICAgICAgICAgICAgICAgIGNvbnN0IGV4dGVuc2lvbnMgPSBbJ2xlc3MnLCAnc2NzcyddO1xyXG5cclxuICAgICAgICAgICAgICAgIGNvbnN0IHdhdGNoUGF0aHM6IHN0cmluZ1tdID0gW107XHJcblxyXG4gICAgICAgICAgICAgICAgZmlsZS5pbnB1dC5mb3JFYWNoKChwYXRoKSA9PntcclxuICAgICAgICAgICAgICAgICAgICB3YXRjaFBhdGhzLnB1c2gocGF0aCk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCBleHRlbnNpb24gb2YgZXh0ZW5zaW9ucylcclxuICAgICAgICAgICAgICAgICAgICBpZiAoTWF0ZUNvbmZpZ0ZpbGUuaGFzRXh0ZW5zaW9uKGZpbGUuaW5wdXQsIGV4dGVuc2lvbikpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHdhdGNoUGF0aHMucHVzaCgnLi8qKi8qLicgKyBleHRlbnNpb24pO1xyXG5cclxuICAgICAgICAgICAgICAgIGNvbnN0IHdhdGNoID0gY2hva2lkYXIud2F0Y2god2F0Y2hQYXRocywgeyBwZXJzaXN0ZW50OiB0cnVlfSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5vbignY2hhbmdlJywgKGV2ZW50LCBwYXRoOiBzdHJpbmcpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBydW5GaWxlcyhjb25maWcsIGZpbGUsIFtidWlsZE5hbWVdKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgIGFsbFdhdGNoZXJzLnB1c2god2F0Y2gpO1xyXG5cclxuICAgICAgICAgICAgICAgIC8vIGFwcGVuZFdhdGNoRm9ySW1wb3J0ZWRGaWxlcyhjb25maWcsIGZpbGUsIGJ1aWxkTmFtZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG4gICAgXHJcbiAgICBydW5CdWlsZChidWlsZHMpO1xyXG59XHJcblxyXG4vLyBjb25zdCBhcHBlbmRXYXRjaEZvckltcG9ydGVkRmlsZXMgPSBmdW5jdGlvbihjb25maWc6IE1hdGVDb25maWcsIGZpbGU6IE1hdGVDb25maWdGaWxlLCBidWlsZE5hbWU6IHN0cmluZyk6IHZvaWR7XHJcblxyXG4vLyAgICAgY29uc3QgZXh0ZW5zaW9ucyA9IFsnbGVzcycsICdzY3NzJ107XHJcblxyXG4vLyAgICAgZXh0ZW5zaW9ucy5mb3JFYWNoKChleHRlbnNpb246IHN0cmluZyk6IHZvaWQgPT4ge1xyXG5cclxuLy8gICAgICAgICBpZiAoIU1hdGVDb25maWdGaWxlLmhhc0V4dGVuc2lvbihmaWxlLmlucHV0LCBleHRlbnNpb24pKVxyXG4vLyAgICAgICAgICAgICByZXR1cm47XHJcbiAgICBcclxuLy8gICAgICAgICBjb25zdCB3YXRjaCA9IGNob2tpZGFyLndhdGNoKCcqKi8qLicgKyBleHRlbnNpb24sIHsgcGVyc2lzdGVudDogdHJ1ZX0pXHJcbi8vICAgICAgICAgICAgICAgICAgICAgICAgICAgICAub24oJ2NoYW5nZScsIChldmVudCwgcGF0aDogc3RyaW5nKSA9PiB7XHJcbi8vICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcnVuRmlsZXMoY29uZmlnLCBmaWxlLCBbYnVpbGROYW1lXSk7XHJcbi8vICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuXHJcbi8vICAgICAgICAgYWxsV2F0Y2hlcnMucHVzaCh3YXRjaCk7XHJcbi8vICAgICB9KTtcclxuLy8gfVxyXG5cclxuZXhwb3J0IGNvbnN0IHJ1bkJ1aWxkID0gZnVuY3Rpb24oYnVpbGRzPzogc3RyaW5nW10pIHtcclxuXHJcbiAgICBjb25zb2xlLmxvZygnZXhlY3V0ZWQgYXQgJyArIG5ldyBEYXRlKCkudG9UaW1lU3RyaW5nKCkpO1xyXG4gICAgXHJcbiAgICBjb25zdCBjb25maWcgPSBNYXRlQ29uZmlnLmdldCgpO1xyXG5cclxuICAgIGNvbmZpZy5maWxlcy5mb3JFYWNoKChmaWxlKTogdm9pZCA9PiB7XHJcbiAgICAgICAgXHJcbiAgICAgICAgcnVuRmlsZXMoY29uZmlnLCBmaWxlLCBidWlsZHMpO1xyXG4gICAgfSk7XHJcbn1cclxuXHJcbmNvbnN0IHJ1bkZpbGVzID0gZnVuY3Rpb24oY29uZmlnOiBNYXRlQ29uZmlnLCBmaWxlOiBNYXRlQ29uZmlnRmlsZSwgYnVpbGRzPzogc3RyaW5nW10pIHtcclxuICAgIFxyXG4gICAgaWYgKGJ1aWxkcyA9PT0gdW5kZWZpbmVkIHx8IChidWlsZHMgIT09IG51bGwgJiYgYnVpbGRzLmxlbmd0aCA9PT0gMCkpXHJcbiAgICAgICAgYnVpbGRzID0gWydkZXYnXTtcclxuXHJcbiAgICBmaWxlLm91dHB1dC5mb3JFYWNoKChvdXRwdXQpID0+IHtcclxuICAgIFxyXG4gICAgICAgIGNvbnN0IG91dHB1dEV4dGVudGlvbiA9IG91dHB1dC5zcGxpdCgnLicpLnBvcCgpLnRvTG93ZXJDYXNlKCk7XHJcbiAgICAgICAgY29uc3Qgb3V0cHV0RmlsZU5hbWUgPSBvdXRwdXQucmVwbGFjZSgvXi4qW1xcXFxcXC9dLywgJycpO1xyXG5cclxuICAgICAgICBmaWxlLmJ1aWxkcy5mb3JFYWNoKChidWlsZE5hbWUpOiB2b2lkID0+IHtcclxuXHJcbiAgICAgICAgICAgIGlmIChidWlsZHMgIT09IG51bGwgJiYgYnVpbGRzLmluZGV4T2YoYnVpbGROYW1lKSA9PT0gLTEpXHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcblxyXG4gICAgICAgICAgICBjb25zdCBidWlsZCA9IGNvbmZpZy5nZXRCdWlsZChidWlsZE5hbWUpO1xyXG4gICAgICAgIFxyXG4gICAgICAgICAgICBsZXQgb3V0cHV0RGlyZWN0b3J5ID0gYnVpbGQub3V0RGlyID8gYnVpbGQub3V0RGlyIDogcGF0aC5kaXJuYW1lKG91dHB1dCk7XHJcblxyXG4gICAgICAgICAgICBpZiAoYnVpbGQub3V0RGlyVmVyc2lvbmluZylcclxuICAgICAgICAgICAgICAgIG91dHB1dERpcmVjdG9yeSArPSAnLycgKyBjb25maWcuZ2V0T3V0RGlyVmVyc2lvbigpO1xyXG5cclxuICAgICAgICAgICAgaWYgKGJ1aWxkLm91dERpck5hbWUpXHJcbiAgICAgICAgICAgICAgICBvdXRwdXREaXJlY3RvcnkgKz0gJy8nICsgY29uZmlnLmdldE91dERpck5hbWUoKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIHN3aXRjaCAob3V0cHV0RXh0ZW50aW9uKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgY2FzZSAnY3NzJzpcclxuICAgICAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgICAgICBpZiAoYnVpbGQuY3NzLm91dERpclN1ZmZpeClcclxuICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0RGlyZWN0b3J5ICs9ICcvJyArIGJ1aWxkLmNzcy5vdXREaXJTdWZmaXg7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG5cclxuICAgICAgICAgICAgICAgIGNhc2UgJ2pzJzogXHJcbiAgICAgICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGJ1aWxkLmpzLm91dERpclN1ZmZpeClcclxuICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0RGlyZWN0b3J5ICs9ICcvJyArIGJ1aWxkLmpzLm91dERpclN1ZmZpeDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGlmIChidWlsZC5qcy5kZWNsYXJhdGlvbiA9PT0gdHJ1ZSlcclxuICAgICAgICAgICAgICAgIGNyZWF0ZVR5cGVTY3JpcHREZWNsYXJhdGlvbihmaWxlLmlucHV0LCBvdXRwdXREaXJlY3RvcnksIG91dHB1dEZpbGVOYW1lLCBidWlsZCk7XHJcblxyXG4gICAgICAgICAgICAgICAgbGV0IHByb2Nlc3MgPSBidW5kbGUoZmlsZS5pbnB1dCwgb3V0cHV0RXh0ZW50aW9uLCBidWlsZClcclxuICAgICAgICAgICAgICAgIC5waXBlKGd1bHBDb25jYXQoJ2VtcHR5JykpXHJcblxyXG4gICAgICAgICAgICAgICAgcHJvY2VzcyA9IHByb2Nlc3MucGlwZShndWxwUmVuYW1lKG91dHB1dEZpbGVOYW1lKSlcclxuICAgICAgICAgICAgICAgIC5waXBlKGd1bHAuZGVzdChvdXRwdXREaXJlY3RvcnkpKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIHN3aXRjaCAob3V0cHV0RXh0ZW50aW9uKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgY2FzZSAnY3NzJzpcclxuICAgICAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgICAgICBpZiAoYnVpbGQuY3NzLm1pbmlmeSkge1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgcHJvY2Vzcy5waXBlKGd1bHBDbGVhbkNTUygpKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAucGlwZShndWxwUmVuYW1lKHtzdWZmaXg6IFwiLm1pblwifSkpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC5waXBlKGd1bHAuZGVzdChvdXRwdXREaXJlY3RvcnkpKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcblxyXG4gICAgICAgICAgICAgICAgY2FzZSAnanMnOiBcclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChidWlsZC5qcy5taW5pZnkpIHtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb2Nlc3MucGlwZShndWxwTWluaWZ5KHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4dDp7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3JjOicuanMnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1pbjonLm1pbi5qcydcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH19KSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgLnBpcGUoZ3VscC5kZXN0KG91dHB1dERpcmVjdG9yeSkpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICB9KTtcclxuXHJcbiAgICB9KTtcclxufSJdfQ==
