"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var config_1 = require("./config");
var chokidar = require("chokidar");
var gulp = require('gulp');
var gulpLess = require('gulp-less');
var gulpSass = require('gulp-sass');
var gulpRename = require('gulp-rename');
var gulpConcat = require("gulp-concat");
var gulpTs = require("gulp-typescript");
var gulpSourcemaps = require("gulp-sourcemaps");
var gulpUglify = require('gulp-uglify');
var merge2 = require('merge2');
var gulpCleanCSS = require('gulp-clean-css');
var gulpFilter = require('gulp-filter-each');
var path = require('path');
var bundle = function (files, build) {
    var process = [];
    var groupFilesExtention = '';
    var groupedFiles = [];
    files.forEach(function (file) {
        var fileExtention = file.split('.').pop().toLowerCase();
        if (fileExtention !== groupFilesExtention) {
            if (groupedFiles.length > 0) {
                process.push(compile(groupedFiles, groupFilesExtention, build));
                groupedFiles = [];
            }
            groupFilesExtention = fileExtention;
        }
        groupedFiles.push(file);
    });
    if (groupedFiles.length > 0)
        process.push(compile(groupedFiles, groupFilesExtention, build));
    var stream = merge2();
    process.forEach(function (p) {
        stream.add(p);
    });
    return stream;
};
var compile = function (files, extention, build) {
    var process = gulp.src(files);
    switch (extention) {
        case 'css':
            return process.pipe(gulpConcat('empty'));
        case 'less':
            if (build.css.sourceMap)
                process = process.pipe(gulpSourcemaps.init());
            process = process.pipe(gulpLess());
            if (build.css.sourceMap)
                process = process.pipe(gulpSourcemaps.write());
            return process.pipe(gulpConcat('empty'));
        case 'scss':
            if (build.css.sourceMap)
                process = process.pipe(gulpSourcemaps.init());
            process = process.pipe(gulpSass().on('error', gulpSass.logError));
            if (build.css.sourceMap)
                process = process.pipe(gulpSourcemaps.write());
            return process.pipe(gulpConcat('empty'));
        case 'ts':
            if (build.js.sourceMap)
                process = process.pipe(gulpSourcemaps.init());
            process = process.pipe(gulpTs(build.ts.compilerOptions));
            if (build.js.sourceMap)
                process = process.pipe(gulpSourcemaps.write());
            return process.pipe(gulpConcat('empty'));
        case 'd.ts':
            return process.pipe(gulpTs(config_1.MateConfigTSConfig.declarationCompilerOptions(build.ts.compilerOptions)));
    }
    return process;
};
var createTypeScriptDeclaration = function (files, outputDirectory, outputFileName, build) {
    var typescriptDeclarations = [];
    files.forEach(function (file) {
        var fileExtention = file.split('.').pop().toLowerCase();
        if (fileExtention === 'ts')
            typescriptDeclarations.push(file);
    });
    if (typescriptDeclarations.length > 0)
        compile(typescriptDeclarations, 'd.ts', build)
            .pipe(gulpFilter(function (content, filepath) { return filepath.toLowerCase().endsWith('.d.ts'); }))
            .pipe(gulpConcat('empty'))
            .pipe(gulpRename({
            basename: outputFileName.replace('.js', ''),
            suffix: '.d',
            extname: '.ts'
        }))
            .pipe(gulp.dest(outputDirectory));
};
var allWatchers = [];
exports.watch = function (builds) {
    if (builds === undefined || (builds !== null && builds.length === 0))
        builds = ['dev'];
    var configWatcher = chokidar.watch('mateconfig.json', { persistent: true })
        .on('change', function (event, path) {
        allWatchers.forEach(function (watcher) {
            watcher.close();
        });
        allWatchers = [];
        exports.watch(builds);
    });
    allWatchers.push(configWatcher);
    var config = config_1.MateConfig.get();
    config.files.forEach(function (file) {
        file.builds.forEach(function (buildName) {
            if (builds === null || builds.indexOf(buildName) !== -1) {
                var watch_1 = chokidar.watch(file.input, { persistent: true })
                    .on('change', function (event, path) {
                    runFiles(config, file, [buildName]);
                });
                allWatchers.push(watch_1);
            }
        });
    });
    exports.runBuild(builds);
};
exports.runBuild = function (builds) {
    console.log('executed at ' + new Date().toTimeString());
    var config = config_1.MateConfig.get();
    config.files.forEach(function (file) {
        runFiles(config, file, builds);
    });
};
var runFiles = function (config, file, builds) {
    if (builds === undefined || (builds !== null && builds.length === 0))
        builds = ['dev'];
    file.output.forEach(function (output) {
        var outputExtention = output.split('.').pop().toLowerCase();
        var outputFileName = output.replace(/^.*[\\\/]/, '');
        file.builds.forEach(function (buildName) {
            if (builds !== null && builds.indexOf(buildName) === -1)
                return;
            var build = config.getBuild(buildName);
            var outputDirectory = build.outDir ? build.outDir : path.dirname(output);
            if (build.outDirVersioning)
                outputDirectory += '/' + config.getOutDirVersion();
            if (build.outDirName)
                outputDirectory += '/' + config.getOutDirName();
            switch (outputExtention) {
                case 'css':
                    if (build.css.outDirSuffix)
                        outputDirectory += '/' + build.css.outDirSuffix;
                    break;
                case 'js':
                    if (build.js.outDirSuffix)
                        outputDirectory += '/' + build.js.outDirSuffix;
                    break;
            }
            if (build.js.declaration === true)
                createTypeScriptDeclaration(file.input, outputDirectory, outputFileName, build);
            var process = bundle(file.input, build)
                .pipe(gulpConcat('empty'))
                .pipe(gulpRename(outputFileName))
                .pipe(gulp.dest(outputDirectory));
            switch (outputExtention) {
                case 'css':
                    if (build.css.minify) {
                        process.pipe(gulpCleanCSS())
                            .pipe(gulpRename({ suffix: ".min" }))
                            .pipe(gulp.dest(outputDirectory));
                    }
                    break;
                case 'js':
                    if (build.js.minify) {
                        process.pipe(gulpUglify())
                            .pipe(gulpRename({ suffix: ".min" }))
                            .pipe(gulp.dest(outputDirectory));
                    }
                    break;
            }
        });
    });
};

//# sourceMappingURL=data:application/json;charset=utf8;base64,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LENBQUM7WUFFcEYsSUFBTSxPQUFPLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDO2lCQUN4QyxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDO2lCQUN6QixJQUFJLENBQUMsVUFBVSxDQUFDLGNBQWMsQ0FBQyxDQUFDO2lCQUNoQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDO1lBRWxDLFFBQVEsZUFBZSxFQUFFO2dCQUVyQixLQUFLLEtBQUs7b0JBRU4sSUFBSSxLQUFLLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRTt3QkFFbEIsT0FBTyxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQzs2QkFDM0IsSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUFDLE1BQU0sRUFBRSxNQUFNLEVBQUMsQ0FBQyxDQUFDOzZCQUNsQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDO3FCQUNyQztvQkFDRCxNQUFNO2dCQUVWLEtBQUssSUFBSTtvQkFFTCxJQUFJLEtBQUssQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFO3dCQUVqQixPQUFPLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDOzZCQUN6QixJQUFJLENBQUMsVUFBVSxDQUFDLEVBQUMsTUFBTSxFQUFFLE1BQU0sRUFBQyxDQUFDLENBQUM7NkJBQ2xDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUM7cUJBQ3JDO29CQUNELE1BQU07YUFDYjtRQUVMLENBQUMsQ0FBQyxDQUFDO0lBRVAsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDLENBQUEiLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE1hdGVDb25maWcsIE1hdGVDb25maWdDU1NDb25maWcsIE1hdGVDb25maWdCdWlsZCwgTWF0ZUNvbmZpZ0ZpbGUsIE1hdGVDb25maWdUU0NvbmZpZyB9IGZyb20gXCIuL2NvbmZpZ1wiO1xyXG5pbXBvcnQgY2hva2lkYXIgPSByZXF1aXJlKCdjaG9raWRhcicpO1xyXG5cclxuY29uc3QgZ3VscCA9IHJlcXVpcmUoJ2d1bHAnKTtcclxuY29uc3QgZ3VscExlc3MgPSByZXF1aXJlKCdndWxwLWxlc3MnKTtcclxuY29uc3QgZ3VscFNhc3MgPSByZXF1aXJlKCdndWxwLXNhc3MnKTtcclxuY29uc3QgZ3VscFJlbmFtZSA9IHJlcXVpcmUoJ2d1bHAtcmVuYW1lJyk7XHJcbmNvbnN0IGd1bHBDb25jYXQgPSByZXF1aXJlKFwiZ3VscC1jb25jYXRcIik7XHJcbmNvbnN0IGd1bHBUcyA9IHJlcXVpcmUoXCJndWxwLXR5cGVzY3JpcHRcIik7XHJcbmNvbnN0IGd1bHBTb3VyY2VtYXBzID0gcmVxdWlyZShcImd1bHAtc291cmNlbWFwc1wiKTtcclxuY29uc3QgZ3VscFVnbGlmeSA9IHJlcXVpcmUoJ2d1bHAtdWdsaWZ5Jyk7XHJcbmNvbnN0IG1lcmdlMiA9IHJlcXVpcmUoJ21lcmdlMicpO1xyXG5jb25zdCBndWxwQ2xlYW5DU1MgPSByZXF1aXJlKCdndWxwLWNsZWFuLWNzcycpO1xyXG5jb25zdCBndWxwRmlsdGVyID0gcmVxdWlyZSgnZ3VscC1maWx0ZXItZWFjaCcpO1xyXG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xyXG5cclxuY29uc3QgYnVuZGxlID0gZnVuY3Rpb24oZmlsZXM6IHN0cmluZ1tdLCBidWlsZDogTWF0ZUNvbmZpZ0J1aWxkKTogYW55IHtcclxuXHJcbiAgICBjb25zdCBwcm9jZXNzOiBhbnlbXSA9IFtdO1xyXG5cclxuICAgIGxldCBncm91cEZpbGVzRXh0ZW50aW9uID0gJyc7XHJcbiAgICBsZXQgZ3JvdXBlZEZpbGVzOiBzdHJpbmdbXSA9IFtdO1xyXG4gICAgXHJcbiAgICBmaWxlcy5mb3JFYWNoKChmaWxlKSA9PntcclxuXHJcbiAgICAgICAgY29uc3QgZmlsZUV4dGVudGlvbiA9IGZpbGUuc3BsaXQoJy4nKS5wb3AoKS50b0xvd2VyQ2FzZSgpO1xyXG5cclxuICAgICAgICBpZiAoZmlsZUV4dGVudGlvbiAhPT0gZ3JvdXBGaWxlc0V4dGVudGlvbil7XHJcblxyXG4gICAgICAgICAgICBpZiAoZ3JvdXBlZEZpbGVzLmxlbmd0aCA+IDApXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIHByb2Nlc3MucHVzaChjb21waWxlKGdyb3VwZWRGaWxlcywgZ3JvdXBGaWxlc0V4dGVudGlvbiwgYnVpbGQpKTtcclxuICAgICAgICAgICAgICAgIGdyb3VwZWRGaWxlcyA9IFtdXHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGdyb3VwRmlsZXNFeHRlbnRpb24gPSBmaWxlRXh0ZW50aW9uO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgZ3JvdXBlZEZpbGVzLnB1c2goZmlsZSk7XHJcblxyXG4gICAgfSk7XHJcblxyXG4gICAgaWYgKGdyb3VwZWRGaWxlcy5sZW5ndGggPiAwKVxyXG4gICAgICAgIHByb2Nlc3MucHVzaChjb21waWxlKGdyb3VwZWRGaWxlcywgZ3JvdXBGaWxlc0V4dGVudGlvbiwgYnVpbGQpKTtcclxuXHJcbiAgIGNvbnN0IHN0cmVhbSA9IG1lcmdlMigpO1xyXG5cclxuICAgcHJvY2Vzcy5mb3JFYWNoKChwKSA9PntcclxuICAgIHN0cmVhbS5hZGQocCk7XHJcbiAgIH0pO1xyXG4gICAgXHJcbiAgIHJldHVybiBzdHJlYW07XHJcbn1cclxuXHJcbmNvbnN0IGNvbXBpbGUgPSBmdW5jdGlvbihmaWxlczogc3RyaW5nW10sIGV4dGVudGlvbjogc3RyaW5nLCBidWlsZDogTWF0ZUNvbmZpZ0J1aWxkKTogYW55IHtcclxuXHJcbiAgICBsZXQgcHJvY2VzcyA9IGd1bHAuc3JjKGZpbGVzKTtcclxuXHJcbiAgICBzd2l0Y2ggKGV4dGVudGlvbil7XHJcbiAgICAgICAgY2FzZSAnY3NzJzpcclxuICAgICAgICAgICAgcmV0dXJuIHByb2Nlc3MucGlwZShndWxwQ29uY2F0KCdlbXB0eScpKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgY2FzZSAnbGVzcyc6XHJcblxyXG4gICAgICAgICAgICBpZiAoYnVpbGQuY3NzLnNvdXJjZU1hcClcclxuICAgICAgICAgICAgICAgIHByb2Nlc3MgPSBwcm9jZXNzLnBpcGUoZ3VscFNvdXJjZW1hcHMuaW5pdCgpKTtcclxuXHJcbiAgICAgICAgICAgIHByb2Nlc3MgPSBwcm9jZXNzLnBpcGUoZ3VscExlc3MoKSk7ICAgIFxyXG5cclxuICAgICAgICAgICAgaWYgKGJ1aWxkLmNzcy5zb3VyY2VNYXApXHJcbiAgICAgICAgICAgICAgICBwcm9jZXNzID0gcHJvY2Vzcy5waXBlKGd1bHBTb3VyY2VtYXBzLndyaXRlKCkpO1xyXG5cclxuICAgICAgICAgICAgcmV0dXJuIHByb2Nlc3MucGlwZShndWxwQ29uY2F0KCdlbXB0eScpKTtcclxuXHJcbiAgICAgICAgY2FzZSAnc2Nzcyc6XHJcblxyXG4gICAgICAgICAgICBpZiAoYnVpbGQuY3NzLnNvdXJjZU1hcClcclxuICAgICAgICAgICAgICAgIHByb2Nlc3MgPSBwcm9jZXNzLnBpcGUoZ3VscFNvdXJjZW1hcHMuaW5pdCgpKTtcclxuXHJcbiAgICAgICAgICAgIHByb2Nlc3MgPSBwcm9jZXNzLnBpcGUoZ3VscFNhc3MoKS5vbignZXJyb3InLCBndWxwU2Fzcy5sb2dFcnJvcikpOyAgICBcclxuXHJcbiAgICAgICAgICAgIGlmIChidWlsZC5jc3Muc291cmNlTWFwKVxyXG4gICAgICAgICAgICAgICAgcHJvY2VzcyA9IHByb2Nlc3MucGlwZShndWxwU291cmNlbWFwcy53cml0ZSgpKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIHJldHVybiBwcm9jZXNzLnBpcGUoZ3VscENvbmNhdCgnZW1wdHknKSk7XHJcbiAgICBcclxuICAgICAgICBjYXNlICd0cyc6XHJcblxyXG4gICAgICAgICAgICBpZiAoYnVpbGQuanMuc291cmNlTWFwKVxyXG4gICAgICAgICAgICAgICAgcHJvY2VzcyA9IHByb2Nlc3MucGlwZShndWxwU291cmNlbWFwcy5pbml0KCkpO1xyXG5cclxuICAgICAgICAgICAgcHJvY2VzcyA9IHByb2Nlc3MucGlwZShndWxwVHMoYnVpbGQudHMuY29tcGlsZXJPcHRpb25zKSk7XHJcblxyXG4gICAgICAgICAgICBpZiAoYnVpbGQuanMuc291cmNlTWFwKVxyXG4gICAgICAgICAgICAgICAgcHJvY2VzcyA9IHByb2Nlc3MucGlwZShndWxwU291cmNlbWFwcy53cml0ZSgpKTtcclxuXHJcbiAgICAgICAgICAgIHJldHVybiBwcm9jZXNzLnBpcGUoZ3VscENvbmNhdCgnZW1wdHknKSk7XHJcblxyXG4gICAgICAgIGNhc2UgJ2QudHMnOlxyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIHJldHVybiBwcm9jZXNzLnBpcGUoZ3VscFRzKE1hdGVDb25maWdUU0NvbmZpZy5kZWNsYXJhdGlvbkNvbXBpbGVyT3B0aW9ucyhidWlsZC50cy5jb21waWxlck9wdGlvbnMpKSk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHByb2Nlc3M7XHJcbn1cclxuXHJcbmNvbnN0IGNyZWF0ZVR5cGVTY3JpcHREZWNsYXJhdGlvbiA9IGZ1bmN0aW9uKGZpbGVzOiBzdHJpbmcgW10sIG91dHB1dERpcmVjdG9yeTogc3RyaW5nLCBvdXRwdXRGaWxlTmFtZTogc3RyaW5nLCBidWlsZDogTWF0ZUNvbmZpZ0J1aWxkKTogdm9pZCB7XHJcblxyXG4gICAgY29uc3QgdHlwZXNjcmlwdERlY2xhcmF0aW9uczogc3RyaW5nW10gPSBbXTtcclxuICAgIFxyXG4gICAgZmlsZXMuZm9yRWFjaCgoZmlsZSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGZpbGVFeHRlbnRpb24gPSBmaWxlLnNwbGl0KCcuJykucG9wKCkudG9Mb3dlckNhc2UoKTtcclxuXHJcbiAgICAgICAgaWYgKGZpbGVFeHRlbnRpb24gPT09ICd0cycpXHJcbiAgICAgICAgICAgIHR5cGVzY3JpcHREZWNsYXJhdGlvbnMucHVzaChmaWxlKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGlmICh0eXBlc2NyaXB0RGVjbGFyYXRpb25zLmxlbmd0aCA+IDApXHJcbiAgICAgICAgY29tcGlsZSh0eXBlc2NyaXB0RGVjbGFyYXRpb25zLCAnZC50cycsIGJ1aWxkKVxyXG4gICAgICAgICAgICAucGlwZShndWxwRmlsdGVyKChjb250ZW50LCBmaWxlcGF0aDogc3RyaW5nKSA9PiBmaWxlcGF0aC50b0xvd2VyQ2FzZSgpLmVuZHNXaXRoKCcuZC50cycpKSlcclxuICAgICAgICAgICAgLnBpcGUoZ3VscENvbmNhdCgnZW1wdHknKSlcclxuICAgICAgICAgICAgLnBpcGUoZ3VscFJlbmFtZSh7XHJcbiAgICAgICAgICAgICAgICBiYXNlbmFtZTogb3V0cHV0RmlsZU5hbWUucmVwbGFjZSgnLmpzJywgJycpLFxyXG4gICAgICAgICAgICAgICAgc3VmZml4OiAnLmQnLFxyXG4gICAgICAgICAgICAgICAgZXh0bmFtZTogJy50cydcclxuICAgICAgICAgICAgfSkpXHJcbiAgICAgICAgICAgIC5waXBlKGd1bHAuZGVzdChvdXRwdXREaXJlY3RvcnkpKTtcclxufVxyXG5cclxubGV0IGFsbFdhdGNoZXJzOiBjaG9raWRhci5GU1dhdGNoZXJbXSA9IFtdO1xyXG5cclxuZXhwb3J0IGNvbnN0IHdhdGNoID0gZnVuY3Rpb24oYnVpbGRzPzogc3RyaW5nW10pIHtcclxuXHJcbiAgICBpZiAoYnVpbGRzID09PSB1bmRlZmluZWQgfHwgKGJ1aWxkcyAhPT0gbnVsbCAmJiBidWlsZHMubGVuZ3RoID09PSAwKSlcclxuICAgICAgICBidWlsZHMgPSBbJ2RldiddO1xyXG5cclxuICAgIGNvbnN0IGNvbmZpZ1dhdGNoZXIgPSBjaG9raWRhci53YXRjaCgnbWF0ZWNvbmZpZy5qc29uJywgeyBwZXJzaXN0ZW50OiB0cnVlfSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLm9uKCdjaGFuZ2UnLCAoZXZlbnQsIHBhdGg6IHN0cmluZykgPT4ge1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFsbFdhdGNoZXJzLmZvckVhY2goKHdhdGNoZXI6IGNob2tpZGFyLkZTV2F0Y2hlcikgPT5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3YXRjaGVyLmNsb3NlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGxXYXRjaGVycyA9IFtdO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdhdGNoKGJ1aWxkcyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgIGFsbFdhdGNoZXJzLnB1c2goY29uZmlnV2F0Y2hlcik7XHJcblxyXG4gICAgY29uc3QgY29uZmlnID0gTWF0ZUNvbmZpZy5nZXQoKTtcclxuXHJcbiAgICBjb25maWcuZmlsZXMuZm9yRWFjaCgoZmlsZSkgPT4ge1xyXG4gICAgICAgIGZpbGUuYnVpbGRzLmZvckVhY2goKGJ1aWxkTmFtZSkgPT4ge1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgaWYgKGJ1aWxkcyA9PT0gbnVsbCB8fCBidWlsZHMuaW5kZXhPZihidWlsZE5hbWUpICE9PSAtMSkge1xyXG5cclxuICAgICAgICAgICAgICAgIGNvbnN0IHdhdGNoID0gY2hva2lkYXIud2F0Y2goZmlsZS5pbnB1dCwgeyBwZXJzaXN0ZW50OiB0cnVlfSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5vbignY2hhbmdlJywgKGV2ZW50LCBwYXRoOiBzdHJpbmcpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBydW5GaWxlcyhjb25maWcsIGZpbGUsIFtidWlsZE5hbWVdKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgIGFsbFdhdGNoZXJzLnB1c2god2F0Y2gpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KTtcclxuICAgIFxyXG4gICAgcnVuQnVpbGQoYnVpbGRzKTtcclxufVxyXG5cclxuZXhwb3J0IGNvbnN0IHJ1bkJ1aWxkID0gZnVuY3Rpb24oYnVpbGRzPzogc3RyaW5nW10pIHtcclxuXHJcbiAgICBjb25zb2xlLmxvZygnZXhlY3V0ZWQgYXQgJyArIG5ldyBEYXRlKCkudG9UaW1lU3RyaW5nKCkpO1xyXG4gICAgXHJcbiAgICBjb25zdCBjb25maWcgPSBNYXRlQ29uZmlnLmdldCgpO1xyXG5cclxuICAgIGNvbmZpZy5maWxlcy5mb3JFYWNoKChmaWxlKTogdm9pZCA9PiB7XHJcbiAgICAgICAgXHJcbiAgICAgICAgcnVuRmlsZXMoY29uZmlnLCBmaWxlLCBidWlsZHMpO1xyXG4gICAgfSk7XHJcbn1cclxuXHJcbmNvbnN0IHJ1bkZpbGVzID0gZnVuY3Rpb24oY29uZmlnOiBNYXRlQ29uZmlnLCBmaWxlOiBNYXRlQ29uZmlnRmlsZSwgYnVpbGRzPzogc3RyaW5nW10pIHtcclxuICAgIFxyXG4gICAgaWYgKGJ1aWxkcyA9PT0gdW5kZWZpbmVkIHx8IChidWlsZHMgIT09IG51bGwgJiYgYnVpbGRzLmxlbmd0aCA9PT0gMCkpXHJcbiAgICAgICAgYnVpbGRzID0gWydkZXYnXTtcclxuXHJcbiAgICBmaWxlLm91dHB1dC5mb3JFYWNoKChvdXRwdXQpID0+IHtcclxuICAgIFxyXG4gICAgICAgIGNvbnN0IG91dHB1dEV4dGVudGlvbiA9IG91dHB1dC5zcGxpdCgnLicpLnBvcCgpLnRvTG93ZXJDYXNlKCk7XHJcbiAgICAgICAgY29uc3Qgb3V0cHV0RmlsZU5hbWUgPSBvdXRwdXQucmVwbGFjZSgvXi4qW1xcXFxcXC9dLywgJycpO1xyXG5cclxuICAgICAgICBmaWxlLmJ1aWxkcy5mb3JFYWNoKChidWlsZE5hbWUpOiB2b2lkID0+IHtcclxuXHJcbiAgICAgICAgICAgIGlmIChidWlsZHMgIT09IG51bGwgJiYgYnVpbGRzLmluZGV4T2YoYnVpbGROYW1lKSA9PT0gLTEpXHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcblxyXG4gICAgICAgICAgICBjb25zdCBidWlsZCA9IGNvbmZpZy5nZXRCdWlsZChidWlsZE5hbWUpO1xyXG4gICAgICAgIFxyXG4gICAgICAgICAgICBsZXQgb3V0cHV0RGlyZWN0b3J5ID0gYnVpbGQub3V0RGlyID8gYnVpbGQub3V0RGlyIDogcGF0aC5kaXJuYW1lKG91dHB1dCk7XHJcblxyXG4gICAgICAgICAgICBpZiAoYnVpbGQub3V0RGlyVmVyc2lvbmluZylcclxuICAgICAgICAgICAgICAgIG91dHB1dERpcmVjdG9yeSArPSAnLycgKyBjb25maWcuZ2V0T3V0RGlyVmVyc2lvbigpO1xyXG5cclxuICAgICAgICAgICAgaWYgKGJ1aWxkLm91dERpck5hbWUpXHJcbiAgICAgICAgICAgICAgICBvdXRwdXREaXJlY3RvcnkgKz0gJy8nICsgY29uZmlnLmdldE91dERpck5hbWUoKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIHN3aXRjaCAob3V0cHV0RXh0ZW50aW9uKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgY2FzZSAnY3NzJzpcclxuICAgICAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgICAgICBpZiAoYnVpbGQuY3NzLm91dERpclN1ZmZpeClcclxuICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0RGlyZWN0b3J5ICs9ICcvJyArIGJ1aWxkLmNzcy5vdXREaXJTdWZmaXg7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG5cclxuICAgICAgICAgICAgICAgIGNhc2UgJ2pzJzogXHJcbiAgICAgICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGJ1aWxkLmpzLm91dERpclN1ZmZpeClcclxuICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0RGlyZWN0b3J5ICs9ICcvJyArIGJ1aWxkLmpzLm91dERpclN1ZmZpeDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGlmIChidWlsZC5qcy5kZWNsYXJhdGlvbiA9PT0gdHJ1ZSlcclxuICAgICAgICAgICAgICAgIGNyZWF0ZVR5cGVTY3JpcHREZWNsYXJhdGlvbihmaWxlLmlucHV0LCBvdXRwdXREaXJlY3RvcnksIG91dHB1dEZpbGVOYW1lLCBidWlsZCk7XHJcblxyXG4gICAgICAgICAgICBjb25zdCBwcm9jZXNzID0gYnVuZGxlKGZpbGUuaW5wdXQsIGJ1aWxkKVxyXG4gICAgICAgICAgICAucGlwZShndWxwQ29uY2F0KCdlbXB0eScpKVxyXG4gICAgICAgICAgICAucGlwZShndWxwUmVuYW1lKG91dHB1dEZpbGVOYW1lKSlcclxuICAgICAgICAgICAgLnBpcGUoZ3VscC5kZXN0KG91dHB1dERpcmVjdG9yeSkpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgc3dpdGNoIChvdXRwdXRFeHRlbnRpb24pIHtcclxuXHJcbiAgICAgICAgICAgICAgICBjYXNlICdjc3MnOlxyXG4gICAgICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChidWlsZC5jc3MubWluaWZ5KSB7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBwcm9jZXNzLnBpcGUoZ3VscENsZWFuQ1NTKCkpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC5waXBlKGd1bHBSZW5hbWUoe3N1ZmZpeDogXCIubWluXCJ9KSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgLnBpcGUoZ3VscC5kZXN0KG91dHB1dERpcmVjdG9yeSkpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuXHJcbiAgICAgICAgICAgICAgICBjYXNlICdqcyc6IFxyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGJ1aWxkLmpzLm1pbmlmeSkge1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgcHJvY2Vzcy5waXBlKGd1bHBVZ2xpZnkoKSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgLnBpcGUoZ3VscFJlbmFtZSh7c3VmZml4OiBcIi5taW5cIn0pKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAucGlwZShndWxwLmRlc3Qob3V0cHV0RGlyZWN0b3J5KSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgIH0pO1xyXG59Il19
