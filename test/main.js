"use strict";
exports.__esModule = true;
var config_1 = require("./config");
var chokidar = require("chokidar");
var gulp = require('gulp');
var gulpLess = require('gulp-less');
var gulpSass = require('gulp-sass');
var gulpRename = require('gulp-rename');
var gulpConcat = require("gulp-concat");
var gulpTs = require("gulp-typescript");
var gulpSourcemaps = require("gulp-sourcemaps");
var gulpUglify = require('gulp-uglify');
var merge2 = require('merge2');
var gulpCleanCSS = require('gulp-clean-css');
var gulpFilter = require('gulp-filter-each');
var path = require('path');
var bundle = function (files, build) {
    var process = [];
    var groupFilesExtention = '';
    var groupedFiles = [];
    files.forEach(function (file) {
        var fileExtention = file.split('.').pop().toLowerCase();
        if (fileExtention !== groupFilesExtention) {
            if (groupedFiles.length > 0) {
                process.push(compile(groupedFiles, groupFilesExtention, build));
                groupedFiles = [];
            }
            groupFilesExtention = fileExtention;
        }
        groupedFiles.push(file);
    });
    if (groupedFiles.length > 0)
        process.push(compile(groupedFiles, groupFilesExtention, build));
    var stream = merge2();
    process.forEach(function (p) {
        stream.add(p);
    });
    return stream;
};
var compile = function (files, extention, build) {
    var process = gulp.src(files);
    switch (extention) {
        case 'css':
            return process.pipe(gulpConcat('empty'));
        case 'less':
            if (build.css.sourceMap)
                process = process.pipe(gulpSourcemaps.init());
            process = process.pipe(gulpLess());
            if (build.css.sourceMap)
                process = process.pipe(gulpSourcemaps.write());
            return process.pipe(gulpConcat('empty'));
        case 'scss':
            if (build.css.sourceMap)
                process = process.pipe(gulpSourcemaps.init());
            process = process.pipe(gulpSass().on('error', gulpSass.logError));
            if (build.css.sourceMap)
                process = process.pipe(gulpSourcemaps.write());
            return process.pipe(gulpConcat('empty'));
        case 'ts':
            if (build.js.sourceMap)
                process = process.pipe(gulpSourcemaps.init());
            process = process.pipe(gulpTs(build.ts.compilerOptions));
            if (build.js.sourceMap)
                process = process.pipe(gulpSourcemaps.write());
            return process.pipe(gulpConcat('empty'));
        case 'd.ts':
            return process.pipe(gulpTs({ declaration: true }));
    }
    return process;
};
var createTypeScriptDeclaration = function (files, outputDirectory, outputFileName, build) {
    var typescriptDeclarations = [];
    files.forEach(function (file) {
        var fileExtention = file.split('.').pop().toLowerCase();
        if (fileExtention === 'ts')
            typescriptDeclarations.push(file);
    });
    if (typescriptDeclarations.length > 0)
        compile(typescriptDeclarations, 'd.ts', build)
            .pipe(gulpFilter(function (content, filepath) { return filepath.toLowerCase().endsWith('.d.ts'); }))
            .pipe(gulpConcat('empty'))
            .pipe(gulpRename({
            basename: outputFileName.replace('.js', ''),
            suffix: '.d',
            extname: '.ts'
        }))
            .pipe(gulp.dest(outputDirectory));
};
var allWatchers = [];
exports.watch = function (builds) {
    if (builds === undefined || (builds !== null && builds.length === 0))
        builds = ['dev'];
    var configWatcher = chokidar.watch('mateconfig.json', { persistent: true })
        .on('change', function (event, path) {
        allWatchers.forEach(function (watcher) {
            watcher.close();
        });
        allWatchers = [];
        exports.watch(builds);
    });
    allWatchers.push(configWatcher);
    var config = config_1.MateConfig.get();
    config.files.forEach(function (file) {
        file.builds.forEach(function (buildName) {
            if (builds === null || builds.indexOf(buildName) !== -1) {
                var watch_1 = chokidar.watch(file.input, { persistent: true })
                    .on('change', function (event, path) {
                    runFiles(config, file, [buildName]);
                });
                allWatchers.push(watch_1);
            }
        });
    });
    exports.runBuild(builds);
};
exports.runBuild = function (builds) {
    console.log('executed at ' + new Date().toTimeString());
    var config = config_1.MateConfig.get();
    config.files.forEach(function (file) {
        runFiles(config, file, builds);
    });
};
var runFiles = function (config, file, builds) {
    if (builds === undefined || (builds !== null && builds.length === 0))
        builds = ['dev'];
    file.output.forEach(function (output) {
        var outputExtention = output.split('.').pop().toLowerCase();
        var outputFileName = output.replace(/^.*[\\\/]/, '');
        file.builds.forEach(function (buildName) {
            if (builds !== null && builds.indexOf(buildName) === -1)
                return;
            var build = config.getBuild(buildName);
            var outputDirectory = build.outDir ? build.outDir : path.dirname(output);
            if (build.outDirVersioning)
                outputDirectory += '/' + config.getOutDirVersion();
            if (build.outDirName)
                outputDirectory += '/' + config.getOutDirName();
            switch (outputExtention) {
                case 'css':
                    if (build.css.outDirSuffix)
                        outputDirectory += '/' + build.css.outDirSuffix;
                    break;
                case 'js':
                    if (build.js.outDirSuffix)
                        outputDirectory += '/' + build.js.outDirSuffix;
                    break;
            }
            if (build.js.declaration === true)
                createTypeScriptDeclaration(file.input, outputDirectory, outputFileName, build);
            var process = bundle(file.input, build)
                .pipe(gulpConcat('empty'))
                .pipe(gulpRename(outputFileName))
                .pipe(gulp.dest(outputDirectory));
            switch (outputExtention) {
                case 'css':
                    if (build.css.minify) {
                        process.pipe(gulpCleanCSS())
                            .pipe(gulpRename({ suffix: ".min" }))
                            .pipe(gulp.dest(outputDirectory));
                    }
                    break;
                case 'js':
                    if (build.js.minify) {
                        process.pipe(gulpUglify())
                            .pipe(gulpRename({ suffix: ".min" }))
                            .pipe(gulp.dest(outputDirectory));
                    }
                    break;
            }
        });
    });
};

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQztpQkFDeEMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQztpQkFDekIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxjQUFjLENBQUMsQ0FBQztpQkFDaEMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQztZQUVsQyxRQUFRLGVBQWUsRUFBRTtnQkFFckIsS0FBSyxLQUFLO29CQUVOLElBQUksS0FBSyxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUU7d0JBRWxCLE9BQU8sQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7NkJBQzNCLElBQUksQ0FBQyxVQUFVLENBQUMsRUFBQyxNQUFNLEVBQUUsTUFBTSxFQUFDLENBQUMsQ0FBQzs2QkFDbEMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQztxQkFDckM7b0JBQ0QsTUFBTTtnQkFFVixLQUFLLElBQUk7b0JBRUwsSUFBSSxLQUFLLENBQUMsRUFBRSxDQUFDLE1BQU0sRUFBRTt3QkFFakIsT0FBTyxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQzs2QkFDekIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUFDLE1BQU0sRUFBRSxNQUFNLEVBQUMsQ0FBQyxDQUFDOzZCQUNsQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDO3FCQUNyQztvQkFDRCxNQUFNO2FBQ2I7UUFFTCxDQUFDLENBQUMsQ0FBQztJQUVQLENBQUMsQ0FBQyxDQUFDO0FBQ1AsQ0FBQyxDQUFBIiwiZmlsZSI6Im1haW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBNYXRlQ29uZmlnLCBNYXRlQ29uZmlnQ1NTQ29uZmlnLCBNYXRlQ29uZmlnQnVpbGQsIE1hdGVDb25maWdGaWxlIH0gZnJvbSBcIi4vY29uZmlnXCI7XHJcbmltcG9ydCBjaG9raWRhciA9IHJlcXVpcmUoJ2Nob2tpZGFyJyk7XHJcblxyXG5jb25zdCBndWxwID0gcmVxdWlyZSgnZ3VscCcpO1xyXG5jb25zdCBndWxwTGVzcyA9IHJlcXVpcmUoJ2d1bHAtbGVzcycpO1xyXG5jb25zdCBndWxwU2FzcyA9IHJlcXVpcmUoJ2d1bHAtc2FzcycpO1xyXG5jb25zdCBndWxwUmVuYW1lID0gcmVxdWlyZSgnZ3VscC1yZW5hbWUnKTtcclxuY29uc3QgZ3VscENvbmNhdCA9IHJlcXVpcmUoXCJndWxwLWNvbmNhdFwiKTtcclxuY29uc3QgZ3VscFRzID0gcmVxdWlyZShcImd1bHAtdHlwZXNjcmlwdFwiKTtcclxuY29uc3QgZ3VscFNvdXJjZW1hcHMgPSByZXF1aXJlKFwiZ3VscC1zb3VyY2VtYXBzXCIpO1xyXG5jb25zdCBndWxwVWdsaWZ5ID0gcmVxdWlyZSgnZ3VscC11Z2xpZnknKTtcclxuY29uc3QgbWVyZ2UyID0gcmVxdWlyZSgnbWVyZ2UyJyk7XHJcbmNvbnN0IGd1bHBDbGVhbkNTUyA9IHJlcXVpcmUoJ2d1bHAtY2xlYW4tY3NzJyk7XHJcbmNvbnN0IGd1bHBGaWx0ZXIgPSByZXF1aXJlKCdndWxwLWZpbHRlci1lYWNoJyk7XHJcbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XHJcblxyXG5jb25zdCBidW5kbGUgPSBmdW5jdGlvbihmaWxlczogc3RyaW5nW10sIGJ1aWxkOiBNYXRlQ29uZmlnQnVpbGQpOiBhbnkge1xyXG5cclxuICAgIGNvbnN0IHByb2Nlc3M6IGFueVtdID0gW107XHJcblxyXG4gICAgbGV0IGdyb3VwRmlsZXNFeHRlbnRpb24gPSAnJztcclxuICAgIGxldCBncm91cGVkRmlsZXM6IHN0cmluZ1tdID0gW107XHJcbiAgICBcclxuICAgIGZpbGVzLmZvckVhY2goKGZpbGUpID0+e1xyXG5cclxuICAgICAgICBjb25zdCBmaWxlRXh0ZW50aW9uID0gZmlsZS5zcGxpdCgnLicpLnBvcCgpLnRvTG93ZXJDYXNlKCk7XHJcblxyXG4gICAgICAgIGlmIChmaWxlRXh0ZW50aW9uICE9PSBncm91cEZpbGVzRXh0ZW50aW9uKXtcclxuXHJcbiAgICAgICAgICAgIGlmIChncm91cGVkRmlsZXMubGVuZ3RoID4gMClcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgcHJvY2Vzcy5wdXNoKGNvbXBpbGUoZ3JvdXBlZEZpbGVzLCBncm91cEZpbGVzRXh0ZW50aW9uLCBidWlsZCkpO1xyXG4gICAgICAgICAgICAgICAgZ3JvdXBlZEZpbGVzID0gW11cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgZ3JvdXBGaWxlc0V4dGVudGlvbiA9IGZpbGVFeHRlbnRpb247XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBncm91cGVkRmlsZXMucHVzaChmaWxlKTtcclxuXHJcbiAgICB9KTtcclxuXHJcbiAgICBpZiAoZ3JvdXBlZEZpbGVzLmxlbmd0aCA+IDApXHJcbiAgICAgICAgcHJvY2Vzcy5wdXNoKGNvbXBpbGUoZ3JvdXBlZEZpbGVzLCBncm91cEZpbGVzRXh0ZW50aW9uLCBidWlsZCkpO1xyXG5cclxuICAgY29uc3Qgc3RyZWFtID0gbWVyZ2UyKCk7XHJcblxyXG4gICBwcm9jZXNzLmZvckVhY2goKHApID0+e1xyXG4gICAgc3RyZWFtLmFkZChwKTtcclxuICAgfSk7XHJcbiAgICBcclxuICAgcmV0dXJuIHN0cmVhbTtcclxufVxyXG5cclxuY29uc3QgY29tcGlsZSA9IGZ1bmN0aW9uKGZpbGVzOiBzdHJpbmdbXSwgZXh0ZW50aW9uOiBzdHJpbmcsIGJ1aWxkOiBNYXRlQ29uZmlnQnVpbGQpOiBhbnkge1xyXG5cclxuICAgIGxldCBwcm9jZXNzID0gZ3VscC5zcmMoZmlsZXMpO1xyXG5cclxuICAgIHN3aXRjaCAoZXh0ZW50aW9uKXtcclxuICAgICAgICBjYXNlICdjc3MnOlxyXG4gICAgICAgICAgICByZXR1cm4gcHJvY2Vzcy5waXBlKGd1bHBDb25jYXQoJ2VtcHR5JykpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICBjYXNlICdsZXNzJzpcclxuXHJcbiAgICAgICAgICAgIGlmIChidWlsZC5jc3Muc291cmNlTWFwKVxyXG4gICAgICAgICAgICAgICAgcHJvY2VzcyA9IHByb2Nlc3MucGlwZShndWxwU291cmNlbWFwcy5pbml0KCkpO1xyXG5cclxuICAgICAgICAgICAgcHJvY2VzcyA9IHByb2Nlc3MucGlwZShndWxwTGVzcygpKTsgICAgXHJcblxyXG4gICAgICAgICAgICBpZiAoYnVpbGQuY3NzLnNvdXJjZU1hcClcclxuICAgICAgICAgICAgICAgIHByb2Nlc3MgPSBwcm9jZXNzLnBpcGUoZ3VscFNvdXJjZW1hcHMud3JpdGUoKSk7XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gcHJvY2Vzcy5waXBlKGd1bHBDb25jYXQoJ2VtcHR5JykpO1xyXG5cclxuICAgICAgICBjYXNlICdzY3NzJzpcclxuXHJcbiAgICAgICAgICAgIGlmIChidWlsZC5jc3Muc291cmNlTWFwKVxyXG4gICAgICAgICAgICAgICAgcHJvY2VzcyA9IHByb2Nlc3MucGlwZShndWxwU291cmNlbWFwcy5pbml0KCkpO1xyXG5cclxuICAgICAgICAgICAgcHJvY2VzcyA9IHByb2Nlc3MucGlwZShndWxwU2FzcygpLm9uKCdlcnJvcicsIGd1bHBTYXNzLmxvZ0Vycm9yKSk7ICAgIFxyXG5cclxuICAgICAgICAgICAgaWYgKGJ1aWxkLmNzcy5zb3VyY2VNYXApXHJcbiAgICAgICAgICAgICAgICBwcm9jZXNzID0gcHJvY2Vzcy5waXBlKGd1bHBTb3VyY2VtYXBzLndyaXRlKCkpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgcmV0dXJuIHByb2Nlc3MucGlwZShndWxwQ29uY2F0KCdlbXB0eScpKTtcclxuICAgIFxyXG4gICAgICAgIGNhc2UgJ3RzJzpcclxuXHJcbiAgICAgICAgICAgIGlmIChidWlsZC5qcy5zb3VyY2VNYXApXHJcbiAgICAgICAgICAgICAgICBwcm9jZXNzID0gcHJvY2Vzcy5waXBlKGd1bHBTb3VyY2VtYXBzLmluaXQoKSk7XHJcblxyXG4gICAgICAgICAgICBwcm9jZXNzID0gcHJvY2Vzcy5waXBlKGd1bHBUcyhidWlsZC50cy5jb21waWxlck9wdGlvbnMpKTtcclxuXHJcbiAgICAgICAgICAgIGlmIChidWlsZC5qcy5zb3VyY2VNYXApXHJcbiAgICAgICAgICAgICAgICBwcm9jZXNzID0gcHJvY2Vzcy5waXBlKGd1bHBTb3VyY2VtYXBzLndyaXRlKCkpO1xyXG5cclxuICAgICAgICAgICAgcmV0dXJuIHByb2Nlc3MucGlwZShndWxwQ29uY2F0KCdlbXB0eScpKTtcclxuXHJcbiAgICAgICAgY2FzZSAnZC50cyc6XHJcbiAgICAgICAgICAgIHJldHVybiBwcm9jZXNzLnBpcGUoZ3VscFRzKHsgZGVjbGFyYXRpb246IHRydWUgfSkpO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBwcm9jZXNzO1xyXG59XHJcblxyXG5jb25zdCBjcmVhdGVUeXBlU2NyaXB0RGVjbGFyYXRpb24gPSBmdW5jdGlvbihmaWxlczogc3RyaW5nIFtdLCBvdXRwdXREaXJlY3Rvcnk6IHN0cmluZywgb3V0cHV0RmlsZU5hbWU6IHN0cmluZywgYnVpbGQ6IE1hdGVDb25maWdCdWlsZCk6IHZvaWQge1xyXG5cclxuICAgIGNvbnN0IHR5cGVzY3JpcHREZWNsYXJhdGlvbnM6IHN0cmluZ1tdID0gW107XHJcbiAgICBcclxuICAgIGZpbGVzLmZvckVhY2goKGZpbGUpID0+IHtcclxuICAgICAgICBjb25zdCBmaWxlRXh0ZW50aW9uID0gZmlsZS5zcGxpdCgnLicpLnBvcCgpLnRvTG93ZXJDYXNlKCk7XHJcblxyXG4gICAgICAgIGlmIChmaWxlRXh0ZW50aW9uID09PSAndHMnKVxyXG4gICAgICAgICAgICB0eXBlc2NyaXB0RGVjbGFyYXRpb25zLnB1c2goZmlsZSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpZiAodHlwZXNjcmlwdERlY2xhcmF0aW9ucy5sZW5ndGggPiAwKVxyXG4gICAgICAgIGNvbXBpbGUodHlwZXNjcmlwdERlY2xhcmF0aW9ucywgJ2QudHMnLCBidWlsZClcclxuICAgICAgICAgICAgLnBpcGUoZ3VscEZpbHRlcigoY29udGVudCwgZmlsZXBhdGg6IHN0cmluZykgPT4gZmlsZXBhdGgudG9Mb3dlckNhc2UoKS5lbmRzV2l0aCgnLmQudHMnKSkpXHJcbiAgICAgICAgICAgIC5waXBlKGd1bHBDb25jYXQoJ2VtcHR5JykpXHJcbiAgICAgICAgICAgIC5waXBlKGd1bHBSZW5hbWUoe1xyXG4gICAgICAgICAgICAgICAgYmFzZW5hbWU6IG91dHB1dEZpbGVOYW1lLnJlcGxhY2UoJy5qcycsICcnKSxcclxuICAgICAgICAgICAgICAgIHN1ZmZpeDogJy5kJyxcclxuICAgICAgICAgICAgICAgIGV4dG5hbWU6ICcudHMnXHJcbiAgICAgICAgICAgIH0pKVxyXG4gICAgICAgICAgICAucGlwZShndWxwLmRlc3Qob3V0cHV0RGlyZWN0b3J5KSk7XHJcbn1cclxuXHJcbmxldCBhbGxXYXRjaGVyczogY2hva2lkYXIuRlNXYXRjaGVyW10gPSBbXTtcclxuXHJcbmV4cG9ydCBjb25zdCB3YXRjaCA9IGZ1bmN0aW9uKGJ1aWxkcz86IHN0cmluZ1tdKSB7XHJcblxyXG4gICAgaWYgKGJ1aWxkcyA9PT0gdW5kZWZpbmVkIHx8IChidWlsZHMgIT09IG51bGwgJiYgYnVpbGRzLmxlbmd0aCA9PT0gMCkpXHJcbiAgICAgICAgYnVpbGRzID0gWydkZXYnXTtcclxuXHJcbiAgICBjb25zdCBjb25maWdXYXRjaGVyID0gY2hva2lkYXIud2F0Y2goJ21hdGVjb25maWcuanNvbicsIHsgcGVyc2lzdGVudDogdHJ1ZX0pXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5vbignY2hhbmdlJywgKGV2ZW50LCBwYXRoOiBzdHJpbmcpID0+IHtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGxXYXRjaGVycy5mb3JFYWNoKCh3YXRjaGVyOiBjaG9raWRhci5GU1dhdGNoZXIpID0+XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2F0Y2hlci5jbG9zZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxsV2F0Y2hlcnMgPSBbXTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3YXRjaChidWlsZHMpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICBhbGxXYXRjaGVycy5wdXNoKGNvbmZpZ1dhdGNoZXIpO1xyXG5cclxuICAgIGNvbnN0IGNvbmZpZyA9IE1hdGVDb25maWcuZ2V0KCk7XHJcblxyXG4gICAgY29uZmlnLmZpbGVzLmZvckVhY2goKGZpbGUpID0+IHtcclxuICAgICAgICBmaWxlLmJ1aWxkcy5mb3JFYWNoKChidWlsZE5hbWUpID0+IHtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGlmIChidWlsZHMgPT09IG51bGwgfHwgYnVpbGRzLmluZGV4T2YoYnVpbGROYW1lKSAhPT0gLTEpIHtcclxuXHJcbiAgICAgICAgICAgICAgICBjb25zdCB3YXRjaCA9IGNob2tpZGFyLndhdGNoKGZpbGUuaW5wdXQsIHsgcGVyc2lzdGVudDogdHJ1ZX0pXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAub24oJ2NoYW5nZScsIChldmVudCwgcGF0aDogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcnVuRmlsZXMoY29uZmlnLCBmaWxlLCBbYnVpbGROYW1lXSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICBhbGxXYXRjaGVycy5wdXNoKHdhdGNoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgICBcclxuICAgIHJ1bkJ1aWxkKGJ1aWxkcyk7XHJcbn1cclxuXHJcbmV4cG9ydCBjb25zdCBydW5CdWlsZCA9IGZ1bmN0aW9uKGJ1aWxkcz86IHN0cmluZ1tdKSB7XHJcblxyXG4gICAgY29uc29sZS5sb2coJ2V4ZWN1dGVkIGF0ICcgKyBuZXcgRGF0ZSgpLnRvVGltZVN0cmluZygpKTtcclxuICAgIFxyXG4gICAgY29uc3QgY29uZmlnID0gTWF0ZUNvbmZpZy5nZXQoKTtcclxuXHJcbiAgICBjb25maWcuZmlsZXMuZm9yRWFjaCgoZmlsZSk6IHZvaWQgPT4ge1xyXG4gICAgICAgIFxyXG4gICAgICAgIHJ1bkZpbGVzKGNvbmZpZywgZmlsZSwgYnVpbGRzKTtcclxuICAgIH0pO1xyXG59XHJcblxyXG5jb25zdCBydW5GaWxlcyA9IGZ1bmN0aW9uKGNvbmZpZzogTWF0ZUNvbmZpZywgZmlsZTogTWF0ZUNvbmZpZ0ZpbGUsIGJ1aWxkcz86IHN0cmluZ1tdKSB7XHJcbiAgICBcclxuICAgIGlmIChidWlsZHMgPT09IHVuZGVmaW5lZCB8fCAoYnVpbGRzICE9PSBudWxsICYmIGJ1aWxkcy5sZW5ndGggPT09IDApKVxyXG4gICAgICAgIGJ1aWxkcyA9IFsnZGV2J107XHJcblxyXG4gICAgZmlsZS5vdXRwdXQuZm9yRWFjaCgob3V0cHV0KSA9PiB7XHJcbiAgICBcclxuICAgICAgICBjb25zdCBvdXRwdXRFeHRlbnRpb24gPSBvdXRwdXQuc3BsaXQoJy4nKS5wb3AoKS50b0xvd2VyQ2FzZSgpO1xyXG4gICAgICAgIGNvbnN0IG91dHB1dEZpbGVOYW1lID0gb3V0cHV0LnJlcGxhY2UoL14uKltcXFxcXFwvXS8sICcnKTtcclxuXHJcbiAgICAgICAgZmlsZS5idWlsZHMuZm9yRWFjaCgoYnVpbGROYW1lKTogdm9pZCA9PiB7XHJcblxyXG4gICAgICAgICAgICBpZiAoYnVpbGRzICE9PSBudWxsICYmIGJ1aWxkcy5pbmRleE9mKGJ1aWxkTmFtZSkgPT09IC0xKVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgYnVpbGQgPSBjb25maWcuZ2V0QnVpbGQoYnVpbGROYW1lKTtcclxuICAgICAgICBcclxuICAgICAgICAgICAgbGV0IG91dHB1dERpcmVjdG9yeSA9IGJ1aWxkLm91dERpciA/IGJ1aWxkLm91dERpciA6IHBhdGguZGlybmFtZShvdXRwdXQpO1xyXG5cclxuICAgICAgICAgICAgaWYgKGJ1aWxkLm91dERpclZlcnNpb25pbmcpXHJcbiAgICAgICAgICAgICAgICBvdXRwdXREaXJlY3RvcnkgKz0gJy8nICsgY29uZmlnLmdldE91dERpclZlcnNpb24oKTtcclxuXHJcbiAgICAgICAgICAgIGlmIChidWlsZC5vdXREaXJOYW1lKVxyXG4gICAgICAgICAgICAgICAgb3V0cHV0RGlyZWN0b3J5ICs9ICcvJyArIGNvbmZpZy5nZXRPdXREaXJOYW1lKCk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBzd2l0Y2ggKG91dHB1dEV4dGVudGlvbikge1xyXG5cclxuICAgICAgICAgICAgICAgIGNhc2UgJ2Nzcyc6XHJcbiAgICAgICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGJ1aWxkLmNzcy5vdXREaXJTdWZmaXgpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG91dHB1dERpcmVjdG9yeSArPSAnLycgKyBidWlsZC5jc3Mub3V0RGlyU3VmZml4O1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuXHJcbiAgICAgICAgICAgICAgICBjYXNlICdqcyc6IFxyXG4gICAgICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChidWlsZC5qcy5vdXREaXJTdWZmaXgpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG91dHB1dERpcmVjdG9yeSArPSAnLycgKyBidWlsZC5qcy5vdXREaXJTdWZmaXg7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBpZiAoYnVpbGQuanMuZGVjbGFyYXRpb24gPT09IHRydWUpXHJcbiAgICAgICAgICAgICAgICBjcmVhdGVUeXBlU2NyaXB0RGVjbGFyYXRpb24oZmlsZS5pbnB1dCwgb3V0cHV0RGlyZWN0b3J5LCBvdXRwdXRGaWxlTmFtZSwgYnVpbGQpO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgcHJvY2VzcyA9IGJ1bmRsZShmaWxlLmlucHV0LCBidWlsZClcclxuICAgICAgICAgICAgLnBpcGUoZ3VscENvbmNhdCgnZW1wdHknKSlcclxuICAgICAgICAgICAgLnBpcGUoZ3VscFJlbmFtZShvdXRwdXRGaWxlTmFtZSkpXHJcbiAgICAgICAgICAgIC5waXBlKGd1bHAuZGVzdChvdXRwdXREaXJlY3RvcnkpKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIHN3aXRjaCAob3V0cHV0RXh0ZW50aW9uKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgY2FzZSAnY3NzJzpcclxuICAgICAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgICAgICBpZiAoYnVpbGQuY3NzLm1pbmlmeSkge1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgcHJvY2Vzcy5waXBlKGd1bHBDbGVhbkNTUygpKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAucGlwZShndWxwUmVuYW1lKHtzdWZmaXg6IFwiLm1pblwifSkpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC5waXBlKGd1bHAuZGVzdChvdXRwdXREaXJlY3RvcnkpKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcblxyXG4gICAgICAgICAgICAgICAgY2FzZSAnanMnOiBcclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChidWlsZC5qcy5taW5pZnkpIHtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb2Nlc3MucGlwZShndWxwVWdsaWZ5KCkpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC5waXBlKGd1bHBSZW5hbWUoe3N1ZmZpeDogXCIubWluXCJ9KSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgLnBpcGUoZ3VscC5kZXN0KG91dHB1dERpcmVjdG9yeSkpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICB9KTtcclxuXHJcbiAgICB9KTtcclxufSJdfQ==
